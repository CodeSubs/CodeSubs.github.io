import Ct from"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/+esm";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const w of l.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&i(w)}).observe(document,{childList:!0,subtree:!0});function e(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(o){if(o.ep)return;o.ep=!0;const l=e(o);fetch(o.href,l)}})();const st="‫";function j(t){return/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(t)}const ft=/^[\s\u061C\u200E\u200F!"#$%&'()*+,\-./:;<=>?@\[\\\]^_`{|}~،؛؟«»ـ…]+/;function Ft(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft),l=o?o[0]:"";return i=i.slice(l.length),i.startsWith(st)}function mt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft);return o?(i=i.slice(o[0].length),j(i)):!1}function xt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return!j(i)||/\{[^{}]*\\alpha&HFF[^{}]*\}\s*[!.?…،.]+$/.test(i)?!1:(i=i.replace(/[\s\u061C\u200E\u200F"«»“”„'`]+$/,""),/[!.?…،:]$/.test(i))}function Lt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/);return(s?s[0]:"").length>0}function Mt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"",i=t.slice(e.length);return/^\s*\d+[.)]\s+/.test(i)}function vt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"",i=t.slice(e.length);if(!/^\s*["«»“”„]/.test(i))return!1;const o=i.match(/["«»“”„]/g);return o&&o.length===1}function Rt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";return t.slice(e.length).includes("!")}function It(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft),l=o?o[0]:"";return i=i.slice(l.length),j(i)}function Pt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return j(i)?(i=i.replace(/[\s\u061C\u200E\u200F"«»“”„'`]+$/,""),/[!؟][؟!]$/.test(i)):!1}function $t(t){return!t||typeof t!="string"?!1:/\\[Nn]/.test(t)}function Ot(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);if(!i.startsWith("!"))return!1;i=i.slice(1);const o=i.match(ft),l=o?o[0]:"";return i=i.slice(l.length),j(i)}function bt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"",i=t.slice(e.length);if(!i)return!1;const o=i[0];return/["«»“”„]/.test(o)}function At(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return!j(i)||/[،؛؟]["'«»“”„]\s*$/.test(i)?!1:(i=i.replace(/[\s\u061C\u200E\u200F"«»“”„'`]+$/,""),/[!.?…،؛؟]$/.test(i))}function Bt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return/[،؛؟]["'«»“”„]\s*$/.test(i)}function kt(t){if(!t||typeof t!="string"||t.indexOf(st)===-1)return!1;const s=t.split(/(\\[Nn])/);for(let e=0;e<s.length;e+=2)if(Ft(s[e]))return!0;return!1}function Tt(t){if(!t||typeof t!="string")return null;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/,l=/[a-zA-Z]/,w=/[\u0590-\u05FF]/,h=/[\s!"#$%&'()*+,\-./:;<=>?@\[\\\]^_`{|}~،؛؟«»ـ…0-9]/,S=new Set([8234,8237,8294,8206]),g=new Set([8235,8238,8295,8207]),M=new Set([8236,8297,1564]);if(!i)return null;let r=!1;for(let b=0;b<i.length;b++){const v=i[b],N=v.charCodeAt(0);if(v==="{"){r=!0;continue}if(r){v==="}"&&(r=!1);continue}if(S.has(N))return"L";if(g.has(N))return"R";if(!M.has(N)&&!h.test(v)){if(o.test(v)||w.test(v))return"R";if(l.test(v))return"L";if(N>=1424&&N<=2303)return"R";if(N<1424&&N>127)return"L"}}return null}function ht(t){if(!t||typeof t!="string")return!1;const s=t.match(/^(?:\{[^{}]*\})*(.*)/);if(s&&s[1]){const o=s[1];if(o.match(/[!\?\.\u2026\u060C\u061B\u061F]+$/)&&j(o)){const w=t.match(/\{[^{}]*\\[1-4]?c&H[^{}]*\}/g);if(w&&w.length>=3)return!1}}const e=kt(t);if(!e){if(Ot(t))return!0;if(Mt(t)||vt(t)||Rt(t)&&!It(t)&&!Pt(t)||Lt(t)&&$t(t)&&j(t)&&Tt(t)==="L")return!1}if(xt(t)&&!e)return!!/[\u202A-\u202E\u200E\u200F\u061C]/.test(t);if(bt(t)&&At(t)&&!e||!bt(t)&&Bt(t)&&!e)return!1;const i=Tt(t);return i==="L"?!1:i==="R"?!0:e}function wt(t){return kt(t)}function Et(t){if(!t||typeof t!="string")return t;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft);let l=o?o[0]:"";if(l&&j(i)){if(l.match(/[.\u2026]{2,}/))return/[.!?؟;:\u061B\u061F\u2026"»”]\s*$/.test(i)?e+st+i:e+l+"‎"+st+i.slice(l.length);if(/["'«»“”„]/.test(l))return e+st+i}return i=i.slice(l.length),i.startsWith(st)?t:e+l+st+i}function Nt(t){if(!t||typeof t!="string")return t;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);if(!j(i)||!/\{[^{}]*\}[^{}]*\{[^{}]*\}/.test(i))return t;const o=[],l=i.match(/^[^\{]+/);if(l){const b=l[0];i=i.slice(b.length),o.push({tag:"",text:b})}const w=/((?:\{[^{}]*\})+)([^\{]*)/g;let h;for(;(h=w.exec(i))!==null;)o.push({tag:h[1],text:h[2]});const S=o[o.length-1];if(!S||!S.text||!/^[!؟؟\.\.\.!،;:…\s]*$/.test(S.text.trim()))return t;const g=S.text.match(/([!؟؟\.\.\.!،;:…\s]+)$/);if(!g)return t;const M=g[1],r=S.text.slice(0,S.text.length-M.length);if(o.length>=3){let b=e;b+=o[0].tag,b+=M,b+=o[1].text.trim(),b+=o[1].tag,b+=" "+o[0].text.trim(),b+=r,b+=o[2].tag;for(let v=3;v<o.length;v++)b+=o[v].tag+o[v].text;return b}return t}function gt(t){t=pt(t);const s=t.split(/(\\[Nn])/);for(let e=0;e<s.length;e+=2){const i=s[e],o=Nt(i);i!==o||o.includes(st)?s[e]=o:s[e]=Et(o)}return s.join("")}function Yt(t){if(!t||typeof t!="string")return t;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft),l=o?o[0]:"";if(i=i.slice(l.length),!i.startsWith(st))return t;let w=l;return w.endsWith("‎")&&(w=w.slice(0,-1)),e+w+i.slice(st.length)}function pt(t){if(!t||typeof t!="string")return t;const s=t.split(/(\\[Nn])/);for(let e=0;e<s.length;e+=2)s[e]=Yt(s[e]);return s.join("")}function Wt(t){const s=/\{([^{}]+)\}/g,e={fn:new Set,fs:new Set,colors:new Set,other:new Set};let i;for(;(i=s.exec(t))!==null;)i[1].split("\\").forEach(w=>{if(!w)return;const h=w.trim();h.startsWith("fn")?e.fn.add(h.substring(2)):h.startsWith("fs")?e.fs.add(h.substring(2)):/^[1-4]?c&H/.test(h)?e.colors.add("\\"+h):(h.startsWith("an")||h.startsWith("pos")||h.startsWith("move")||h.startsWith("fad"))&&e.other.add("\\"+h)});return e}function zt(t){const s=t.split(",");if(s.length<10)return null;const e=s[0],i=e.includes(":")?e.split(":")[1].trim():e.trim();return{Layer:parseInt(i)||0,Start:s[1].trim(),End:s[2].trim(),Style:s[3].trim(),Name:s[4].trim(),MarginL:s[5].trim(),MarginR:s[6].trim(),MarginV:s[7].trim(),Effect:s[8].trim(),Text:s.slice(9).join(",").trim()}}function Xt(t){if(t===0)return"0 Bytes";const s=1024,e=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(s));return Math.round(t/Math.pow(s,i)*100)/100+" "+e[i]}function V(t){if(!t)return 0;const s=t.split(":");if(s.length!==3)return 0;const e=parseInt(s[0],10)||0,i=parseInt(s[1],10)||0,o=s[2].split("."),l=parseInt(o[0],10)||0,w=parseInt((o[1]||"0").padEnd(2,"0").substring(0,2),10);return e*36e5+i*6e4+l*1e3+w*10}function St(t){(isNaN(t)||t<0)&&(t=0);const s=Math.floor(t/36e5);t%=36e5;const e=Math.floor(t/6e4);t%=6e4;const i=Math.floor(t/1e3);t%=1e3;const o=Math.floor(t/10);return`${s}:${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${o.toString().padStart(2,"0")}`}const Vt=Vue.createApp({data(){return{assFile:null,originalFileSnapshot:null,lines:[],editedLineIndices:[],isDragging:!1,fileName:"",fileSize:"0 Bytes",isDarkMode:!1,isProcessing:!1,showDebugModal:!1,debugLineInfo:null,currentIndex:0,rtlPreviewText:"",rtlEditHistory:Object.create(null),rtlEditHistoryLimit:200,errorLog:[],showLinesModalOpen:!1,linesModalType:"all",currentPage:1,pageSize:10,viewMode:"cards",showDummyVideoToggle:!1,dummyVideoUnlockStep:0,dummyVideo:{width:1920,height:1080,color:"#0F2C41",customDuration:null,showOptions:!1,isPlaying:!1,containerWidth:0,containerHeight:0},currentTime:0,playbackInterval:null,resizeObserver:null,useLibassWasm:!0,libassInstance:null,libassReady:!1,libassTrackUpdateTimer:null,libassPartsInstance:null,libassPartsReady:!1,libassPartsTrackUpdateTimer:null,libassPartsFailed:!1,_assMeasureCtx:null,showScriptInfoModal:!1,scriptInfo:[],styles:[],overrideStats:{fn:new Set,fs:new Set,colors:new Set,other:new Set},showFontsModal:!1,jumpToLineNumber:"",deferredPrompt:null,showInstallButton:!1,filterMode:"all",rangeInput:"",isRechecking:!1,mobileMenuOpen:!1,startYear:2026,version:"0.3.5-beta",showDebugButton:!1,showColTime:!1,showColStyle:!1,showColStatus:!1,showColText:!0,showColFontname:!0,showColFontsize:!1,showColPrimaryColour:!1,showColSecondaryColour:!1,showColOutlineColour:!1,showColBackColour:!1,showColBold:!1,showColItalic:!1,showColUnderline:!1,showColStrikeOut:!1,showColScaleX:!1,showColScaleY:!1,showColSpacing:!1,showColAngle:!1,showColBorderStyle:!1,showColOutline:!1,showColShadow:!1,showColAlignment:!1,showColMarginL:!1,showColMarginR:!1,showColMarginV:!1,showColEncoding:!1,showStylesColumnCheckboxes:!1,showBulkConvertModal:!1,showResetConfirmModal:!1,bulkConvertType:"ltr",bulkConvertLinesToConvert:[],bulkConvertProgress:0,bulkConvertTotal:0,bulkConvertSuccess:!1,bulkConvertStartTime:null,bulkConvertEndTime:null,bulkConvertSuccessCount:0,bulkConvertFailureCount:0}},computed:{scriptResolution(){const t=this.scriptInfo.find(l=>l.key==="PlayResX"),s=this.scriptInfo.find(l=>l.key==="PlayResY");let e=t?parseInt(t.value,10):0,i=s?parseInt(s.value,10):0;(!Number.isFinite(e)||e<0)&&(e=0),(!Number.isFinite(i)||i<0)&&(i=0);const o=this.viewMode==="dummy-video"&&Number.isFinite(this.dummyVideo.width)&&this.dummyVideo.width>0&&Number.isFinite(this.dummyVideo.height)&&this.dummyVideo.height>0;return e===0&&i===0?o?(e=this.dummyVideo.width,i=this.dummyVideo.height):(e=384,i=288):e===0?o?e=Math.max(1,Math.round(i*(this.dummyVideo.width/this.dummyVideo.height))):e=i===1024?1280:Math.floor(i*4/3):i===0&&(o?i=Math.max(1,Math.round(e*(this.dummyVideo.height/this.dummyVideo.width))):i=e===1280?1024:Math.floor(e*3/4)),{x:e,y:i}},scriptScaleX(){return this.dummyVideo.containerWidth===0?1:this.dummyVideo.containerWidth/this.scriptResolution.x},scriptScaleY(){return this.dummyVideo.containerHeight===0?1:this.dummyVideo.containerHeight/this.scriptResolution.y},fontScaleFactor(){return this.scriptScaleY},fileMaxDuration(){return this.lines.length===0?0:this.lines.reduce((t,s)=>{const e=V(s.End);return Math.max(t,e)},0)},videoDuration(){return this.dummyVideo.customDuration!==null?this.dummyVideo.customDuration:this.lines.length===0?0:this.lines.reduce((t,s)=>{const e=V(s.End);return Math.max(t,e)},0)},formattedDuration(){return St(this.videoDuration)},formattedCurrentTime(){return St(this.currentTime)},libassPartsEnabled(){return!this.useLibassWasm&&!this.libassPartsFailed&&this.viewMode==="dummy-video"&&!!this.assFile&&typeof Ct<"u"},activeSubtitles(){const t=this.lines.filter(s=>{const e=V(s.Start),i=V(s.End);return this.currentTime>=e&&this.currentTime<=i});if(this.currentIndex>=0&&this.currentIndex<this.lines.length){const s=this.lines[this.currentIndex];if(t.includes(s))return[s]}return t},renderedActiveSubtitles(){return this.libassPartsEnabled?[]:(this.activeSubtitles||[]).map((s,e)=>this.renderAssLine(s,e))},currentLine(){return this.lines[this.currentIndex]},totalLines(){return this.lines.length},rtlCount(){return this.lines.filter(t=>t.displaysRTL).length},ltrCount(){return this.lines.filter(t=>!t.displaysRTL).length},showRTLFilter(){return this.rtlCount>0},showLTRFilter(){return this.ltrCount>0},convertibleToRTLCount(){return this.ltrCount},canConvertToRTL(){const t=this.currentLine;return!t||!t.isArabic||t.isRTL?!1:t.displaysRTL===!1},canConvertToLTR(){const t=this.currentLine;if(!t||!t.isRTL)return!1;try{return ht(pt(t.Text))===!1}catch{return!1}},canUndoRtlEdit(){if(!this.currentLine)return!1;const t=this.rtlEditHistory[String(this.currentIndex)];return!!t&&Array.isArray(t.undo)&&t.undo.length>0},canRedoRtlEdit(){if(!this.currentLine)return!1;const t=this.rtlEditHistory[String(this.currentIndex)];return!!t&&Array.isArray(t.redo)&&t.redo.length>0},canResetRtlEdit(){if(!this.currentLine)return!1;const t=this.rtlEditHistory[String(this.currentIndex)];return!t||!t.base||!t.last?!1:!this.isSameRtlSnapshot(this.normalizeRtlSnapshot(t.base),this.normalizeRtlSnapshot(t.last))},hasFileEdits(){return!!this.assFile&&this.editedLineIndices.length>0},canResetToOriginal(){return!!this.assFile&&!!this.originalFileSnapshot&&this.editedLineIndices.length>0},arabicCount(){return this.lines.filter(t=>t.displaysRTL).length},arabicNeedsRtlCount(){return this.lines.filter(t=>t.displaysRTL&&!t.isRTL).length},conversionPercentage(){return this.totalLines===0?0:Math.round(this.rtlCount/this.totalLines*100)},fontCount(){return new Set(this.styles.map(s=>s.Fontname)).size},bulkConvertDuration(){return!this.bulkConvertStartTime||!this.bulkConvertEndTime?0:(this.bulkConvertEndTime-this.bulkConvertStartTime)/1e3},bulkConvertSpeed(){return this.bulkConvertDuration===0||this.bulkConvertTotal===0?0:Math.round(this.bulkConvertTotal/this.bulkConvertDuration)||0},linesModalTitle(){return this.linesModalType==="rtl"?"الأسطر (RTL)":this.linesModalType==="ltr"?"الأسطر (LTR)":"كل الأسطر"},filteredLines(){return this.linesModalType==="rtl"?this.lines.filter(t=>t.displaysRTL):this.linesModalType==="ltr"?this.lines.filter(t=>!t.displaysRTL):this.lines},editorFilteredLines(){return this.filterMode==="rtl"?this.lines.filter(t=>t.displaysRTL):this.filterMode==="ltr"?this.lines.filter(t=>!t.displaysRTL):this.lines},editorFilteredCount(){return this.editorFilteredLines.length},totalPages(){return Math.ceil(this.filteredLines.length/this.pageSize)},paginatedLines(){const t=(this.currentPage-1)*this.pageSize,s=t+this.pageSize;return this.filteredLines.slice(t,s)},isAnyModalOpen(){return this.showLinesModalOpen||this.showScriptInfoModal||this.showFontsModal},canGoToFirstFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){let s=-1,e=1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=V(o.Start);l<e&&(e=l,s=i)}return s===-1?!1:this.currentIndex!==s?!0:Math.abs((this.currentTime||0)-e)>1}for(let s=0;s<this.lines.length;s++){const e=this.lines[s];if(t(e))return this.currentIndex!==s}return!1},canGoToPreviousFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){const s=this.currentTime||0;for(let e=0;e<this.lines.length;e++){const i=this.lines[e];if(!t(i))continue;if(V(i.End)<s)return!0}return!1}for(let s=this.currentIndex-1;s>=0;s--){const e=this.lines[s];if(t(e))return!0}return!1},canGoToNextFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){const s=this.currentTime||0;for(let e=0;e<this.lines.length;e++){const i=this.lines[e];if(!t(i))continue;if(V(i.Start)>s)return!0}return!1}for(let s=this.currentIndex+1;s<this.lines.length;s++){const e=this.lines[s];if(t(e))return!0}return!1},canGoToLastFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){let s=-1,e=-1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=V(o.Start);l>e&&(e=l,s=i)}return s===-1?!1:this.currentIndex!==s?!0:Math.abs((this.currentTime||0)-e)>1}for(let s=this.lines.length-1;s>=0;s--){const e=this.lines[s];if(t(e))return this.currentIndex!==s}return!1},copyrightYear(){const t=new Date().getFullYear();return t===this.startYear?this.startYear:t>this.startYear?`${this.startYear}-${t}`:this.startYear}},watch:{assFile(t){t?this.viewMode==="dummy-video"&&(this.libassPartsFailed=!1,this.setupResizeObserver(),this.initLibassWasm(),this.initLibassWasmParts()):(this.cleanupResizeObserver(),this.disposeLibassWasm(),this.disposeLibassWasmParts())},useLibassWasm(t){t?(this.disposeLibassWasmParts(),this.initLibassWasm(),this.renderLibassWasm()):(this.libassPartsFailed=!1,this.disposeLibassWasm(),this.initLibassWasmParts(),this.renderLibassWasmParts())},viewMode:{handler(t){t==="dummy-video"?(this.libassPartsFailed=!1,this.setupResizeObserver(),this.initLibassWasm(),this.initLibassWasmParts()):(this.cleanupResizeObserver(),this.disposeLibassWasm(),this.disposeLibassWasmParts())},immediate:!0},currentTime(){this.renderLibassWasm(),this.renderLibassWasmParts()},lines:{handler(){this.scheduleLibassTrackUpdate(),this.scheduleLibassPartsTrackUpdate(),this.syncEditedLineIndices()},deep:!0},"dummyVideo.width"(){this.resizeLibassCanvas(),this.resizeLibassPartsCanvas()},"dummyVideo.height"(){this.resizeLibassCanvas(),this.resizeLibassPartsCanvas()},rtlCount(t){t===0&&this.filterMode==="rtl"&&(this.filterMode="all")},ltrCount(t){t===0&&this.filterMode==="ltr"&&(this.filterMode="all")},showColTime(t){if(!t&&!this.showColStyle&&!this.showColStatus&&!this.showColText){this.$nextTick(()=>{this.showColTime=!0});return}this.saveColumnSettings()},showColStyle(t){if(!t&&!this.showColTime&&!this.showColStatus&&!this.showColText){this.$nextTick(()=>{this.showColStyle=!0});return}this.saveColumnSettings()},showColStatus(t){if(!t&&!this.showColTime&&!this.showColStyle&&!this.showColText){this.$nextTick(()=>{this.showColStatus=!0});return}this.saveColumnSettings()},showColText(t){if(!t&&!this.showColTime&&!this.showColStyle&&!this.showColStatus){this.$nextTick(()=>{this.showColText=!0});return}this.saveColumnSettings()},showColFontname(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColFontname=!0});return}this.saveStylesColumnSettings()},showColFontsize(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColFontsize=!0});return}this.saveStylesColumnSettings()},showColPrimaryColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColPrimaryColour=!0});return}this.saveStylesColumnSettings()},showColSecondaryColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColSecondaryColour=!0});return}this.saveStylesColumnSettings()},showColOutlineColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColOutlineColour=!0});return}this.saveStylesColumnSettings()},showColBackColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColBackColour=!0});return}this.saveStylesColumnSettings()},showColBold(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColBold=!0});return}this.saveStylesColumnSettings()},showColItalic(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColItalic=!0});return}this.saveStylesColumnSettings()},showColUnderline(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColUnderline=!0});return}this.saveStylesColumnSettings()},showColStrikeOut(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColStrikeOut=!0});return}this.saveStylesColumnSettings()},showColScaleX(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColScaleX=!0});return}this.saveStylesColumnSettings()},showColScaleY(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColScaleY=!0});return}this.saveStylesColumnSettings()},showColSpacing(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColSpacing=!0});return}this.saveStylesColumnSettings()},showColAngle(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColAngle=!0});return}this.saveStylesColumnSettings()},showColBorderStyle(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColBorderStyle=!0});return}this.saveStylesColumnSettings()},showColOutline(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColOutline=!0});return}this.saveStylesColumnSettings()},showColShadow(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColShadow=!0});return}this.saveStylesColumnSettings()},showColAlignment(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColAlignment=!0});return}this.saveStylesColumnSettings()},showColMarginL(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColMarginL=!0});return}this.saveStylesColumnSettings()},showColMarginR(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColMarginR=!0});return}this.saveStylesColumnSettings()},showColMarginV(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColMarginV=!0});return}this.saveStylesColumnSettings()},showColEncoding(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColEncoding=!0});return}this.saveStylesColumnSettings()},currentPage(t){t>this.totalPages&&(this.currentPage=this.totalPages)},linesModalType(){this.currentPage=1},filterMode(){for(let t=0;t<this.lines.length;t++){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}}this.currentIndex=-1,this.updateRTLPreview()},isAnyModalOpen(t){t?document.body.style.overflow="hidden":document.body.style.overflow=""},currentIndex(t){if(this.viewMode==="dummy-video"&&t>=0&&t<this.lines.length){const s=this.lines[t];this.currentTime=V(s.Start)}}},mounted(){this.loadTheme(),this.setupSystemThemeListener(),this.setupPWAInstall();const t=localStorage.getItem("lines-modal-columns");if(t)try{const e=JSON.parse(t);e.showColTime!==void 0&&(this.showColTime=e.showColTime),e.showColStyle!==void 0&&(this.showColStyle=e.showColStyle),e.showColStatus!==void 0&&(this.showColStatus=e.showColStatus),e.showColText!==void 0&&(this.showColText=e.showColText)}catch(e){console.error("Failed to load column settings:",e)}const s=localStorage.getItem("styles-modal-columns");if(s)try{const e=JSON.parse(s);e.showColFontname!==void 0&&(this.showColFontname=e.showColFontname),e.showColFontsize!==void 0&&(this.showColFontsize=e.showColFontsize),e.showColPrimaryColour!==void 0&&(this.showColPrimaryColour=e.showColPrimaryColour),e.showColSecondaryColour!==void 0&&(this.showColSecondaryColour=e.showColSecondaryColour),e.showColOutlineColour!==void 0&&(this.showColOutlineColour=e.showColOutlineColour),e.showColBackColour!==void 0&&(this.showColBackColour=e.showColBackColour),e.showColBold!==void 0&&(this.showColBold=e.showColBold),e.showColItalic!==void 0&&(this.showColItalic=e.showColItalic),e.showColUnderline!==void 0&&(this.showColUnderline=e.showColUnderline),e.showColStrikeOut!==void 0&&(this.showColStrikeOut=e.showColStrikeOut),e.showColScaleX!==void 0&&(this.showColScaleX=e.showColScaleX),e.showColScaleY!==void 0&&(this.showColScaleY=e.showColScaleY),e.showColSpacing!==void 0&&(this.showColSpacing=e.showColSpacing),e.showColAngle!==void 0&&(this.showColAngle=e.showColAngle),e.showColBorderStyle!==void 0&&(this.showColBorderStyle=e.showColBorderStyle),e.showColOutline!==void 0&&(this.showColOutline=e.showColOutline),e.showColShadow!==void 0&&(this.showColShadow=e.showColShadow),e.showColAlignment!==void 0&&(this.showColAlignment=e.showColAlignment),e.showColMarginL!==void 0&&(this.showColMarginL=e.showColMarginL),e.showColMarginR!==void 0&&(this.showColMarginR=e.showColMarginR),e.showColMarginV!==void 0&&(this.showColMarginV=e.showColMarginV),e.showColEncoding!==void 0&&(this.showColEncoding=e.showColEncoding)}catch(e){console.error("Failed to load styles column settings:",e)}},beforeUnmount(){this.cleanupResizeObserver(),this.disposeLibassWasm(),this.disposeLibassWasmParts(),document.body.style.overflow=""},methods:{buildAssForLibass(){let t=`[Script Info]
`;t+=`ScriptType: v4.00+
`,t+=`WrapStyle: 0
`,t+=`ScaledBorderAndShadow: yes
`,t+=`YCbCr Matrix: None
`;const{x:s,y:e}=this.scriptResolution;if(t+=`PlayResX: ${s}
`,t+=`PlayResY: ${e}
`,this.scriptInfo.forEach(i=>{["ScriptType","WrapStyle","ScaledBorderAndShadow","YCbCr Matrix","PlayResX","PlayResY"].includes(i.key)||(t+=`${i.key}: ${i.value}
`)}),t+=`
[V4+ Styles]
`,t+=`Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
`,this.styles.length===0)t+=`Style: Default,Arial,20,&H00FFFFFF,&H000000FF,&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,2,2,10,10,10,1
`;else for(const i of this.styles)t+=`Style: ${i.Name},${i.Fontname},${i.Fontsize},${i.PrimaryColour},${i.SecondaryColour},${i.OutlineColour},${i.BackColour},${i.Bold},${i.Italic},${i.Underline},${i.StrikeOut},${i.ScaleX},${i.ScaleY},${i.Spacing},${i.Angle},${i.BorderStyle},${i.Outline},${i.Shadow},${i.Alignment},${i.MarginL},${i.MarginR},${i.MarginV},${i.Encoding}
`;t+=`
[Events]
`,t+=`Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
`;for(const i of this.lines)t+=`Dialogue: ${i.Layer},${i.Start},${i.End},${i.Style},${i.Name},${i.MarginL},${i.MarginR},${i.MarginV},${i.Effect},${i.Text}
`;return t},resizeLibassCanvas(){if(!this.useLibassWasm)return;const t=this.$refs.libassCanvas;if(!t)return;const s=window.devicePixelRatio||1,e=Math.max(1,Math.round((this.dummyVideo.containerWidth||1920)*s)),i=Math.max(1,Math.round((this.dummyVideo.containerHeight||1080)*s));t.width!==e&&(t.width=e),t.height!==i&&(t.height=i),this.libassInstance&&this.libassInstance.resize(e,i)},initLibassWasm(){this.useLibassWasm&&this.assFile&&this.viewMode==="dummy-video"&&(this.libassInstance||this.$nextTick(()=>{if(!this.useLibassWasm||!this.assFile||this.viewMode!=="dummy-video"||this.libassInstance||!this.$refs.libassCanvas)return;if(typeof Ct>"u"){this.useLibassWasm=!1;return}this.libassReady=!1,this.resizeLibassCanvas();const t={canvas:this.$refs.libassCanvas,subContent:this.buildAssForLibass(),workerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker.js",legacyWorkerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker-legacy.js",renderMode:"wasm-blend",fonts:["https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Regular.ttf","https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Bold.ttf"],onReady:()=>{this.libassReady=!0,this.renderLibassWasm()},onError:()=>{this.useLibassWasm=!1,this.disposeLibassWasm()}};try{this.libassInstance=new Ct(t)}catch{this.useLibassWasm=!1,this.disposeLibassWasm()}}))},disposeLibassWasm(){if(this.libassReady=!1,this.libassTrackUpdateTimer&&(clearTimeout(this.libassTrackUpdateTimer),this.libassTrackUpdateTimer=null),this.libassInstance){try{this.libassInstance.dispose()}catch{}this.libassInstance=null}},renderLibassWasm(){this.useLibassWasm&&(!this.libassInstance||!this.libassReady||(this.resizeLibassCanvas(),this.libassInstance.setCurrentTime((this.currentTime||0)/1e3)))},scheduleLibassTrackUpdate(){this.useLibassWasm&&this.libassInstance&&(this.libassTrackUpdateTimer&&clearTimeout(this.libassTrackUpdateTimer),this.libassTrackUpdateTimer=setTimeout(()=>{this.useLibassWasm&&this.libassInstance&&(this.libassInstance.setTrack(this.buildAssForLibass()),this.renderLibassWasm())},250))},resizeLibassPartsCanvas(){if(!this.libassPartsEnabled)return;const t=this.$refs.libassPartsCanvas;if(!t)return;const s=window.devicePixelRatio||1,e=Math.max(1,Math.round((this.dummyVideo.containerWidth||1920)*s)),i=Math.max(1,Math.round((this.dummyVideo.containerHeight||1080)*s));t.width!==e&&(t.width=e),t.height!==i&&(t.height=i),this.libassPartsInstance&&this.libassPartsInstance.resize(e,i)},initLibassWasmParts(){this.libassPartsEnabled&&(this.libassPartsInstance||this.$nextTick(()=>{if(!this.libassPartsEnabled||this.libassPartsInstance||!this.$refs.libassPartsCanvas||typeof Ct>"u")return;this.libassPartsFailed=!1,this.libassPartsReady=!1,this.resizeLibassPartsCanvas();const t={canvas:this.$refs.libassPartsCanvas,subContent:this.buildAssForLibass(),workerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker.js",legacyWorkerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker-legacy.js",renderMode:"wasm-blend",fonts:["https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Regular.ttf","https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Bold.ttf"],onReady:()=>{this.libassPartsReady=!0,this.renderLibassWasmParts()},onError:()=>{this.libassPartsFailed=!0,this.disposeLibassWasmParts()}};try{this.libassPartsInstance=new Ct(t)}catch{this.libassPartsFailed=!0,this.disposeLibassWasmParts()}}))},disposeLibassWasmParts(){if(this.libassPartsReady=!1,this.libassPartsTrackUpdateTimer&&(clearTimeout(this.libassPartsTrackUpdateTimer),this.libassPartsTrackUpdateTimer=null),this.libassPartsInstance){try{this.libassPartsInstance.dispose()}catch{}this.libassPartsInstance=null}},renderLibassWasmParts(){if(this.libassPartsEnabled){if(!this.libassPartsInstance||!this.libassPartsReady){this.initLibassWasmParts();return}this.resizeLibassPartsCanvas(),this.libassPartsInstance.setCurrentTime((this.currentTime||0)/1e3)}},scheduleLibassPartsTrackUpdate(){if(this.libassPartsEnabled){if(!this.libassPartsInstance){this.initLibassWasmParts();return}this.libassPartsTrackUpdateTimer&&clearTimeout(this.libassPartsTrackUpdateTimer),this.libassPartsTrackUpdateTimer=setTimeout(()=>{this.libassPartsEnabled&&this.libassPartsInstance&&(this.libassPartsInstance.setTrack(this.buildAssForLibass()),this.renderLibassWasmParts())},250)}},getFontFamilyStack(t){const s=new Set,e=[],i=o=>{const l=(o||"").trim();if(!l)return;const w=l.toLowerCase();s.has(w)||(s.add(w),e.push(l))};return i(t),i("Tahoma"),i("Arial"),i("Segoe UI"),i("Noto Sans Arabic"),i("Noto Naskh Arabic"),i("Amiri"),i("sans-serif"),e.map(o=>o==="sans-serif"?o:`"${o.replace(/"/g,'\\"')}"`).join(", ")},getLineClipPathId(t){return`ass-clip-${t}`},getLineClipMaskId(t){return`ass-clip-mask-${t}`},renderAssLine(t,s){const e=this.getRenderedParts(t),i=this.getLineStyle(t);if(e.clip&&Number.isFinite(s))if(e.clip.invert){const o=`url(#${this.getLineClipMaskId(s)})`;i.mask=o,i.WebkitMask=o}else{const o=`url(#${this.getLineClipPathId(s)})`;i.clipPath=o,i.WebkitClipPath=o}return{line:t,idx:s,style:i,parts:e.parts,clip:e.clip}},getLineStyle(t){const s={position:"absolute",textAlign:"center",pointerEvents:"none",direction:t.isArabic?"rtl":"ltr"};let e=2;const i=t.Style,o=this.styles.find(g=>g.Name===i);o&&(e=parseInt(o.Alignment));const l=t.Text.match(/\\an([1-9])/);if(l&&(e=parseInt(l[1])),!l){const g=t.Text.match(/\\a(\d+)/);if(g){const M=parseInt(g[1]),r={1:1,2:2,3:3,5:7,6:8,7:9,9:4,10:5,11:6};r[M]&&(e=r[M])}}let w=t.Text.match(/\\pos\s*\(\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*\)/);const h=t.Text.match(/\\move\s*\(\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*(?:,\s*(-?\d+)\s*,\s*(-?\d+)\s*)?\)/);let S=null;if(h){const g=parseFloat(h[1]),M=parseFloat(h[3]),r=parseFloat(h[5]),b=parseFloat(h[7]),v=h[9]?parseInt(h[9]):0,N=h[10]?parseInt(h[10]):0,z=V(t.Start),J=V(t.End)-z,B=this.currentTime-z,R=v,Y=N>0?N:J;let A=0;B<=R?A=0:B>=Y?A=1:A=(B-R)/(Y-R);const _=g+(r-g)*A,Z=M+(b-M)*A;S={x:_,y:Z}}else w&&(S={x:parseFloat(w[1]),y:parseFloat(w[3])});if(S){const g=S.x,M=S.y;let r="-50%",b="-50%";[1,4,7].includes(e)&&(r="0%"),[3,6,9].includes(e)&&(r="-100%"),[1,2,3].includes(e)&&(b="-100%"),[7,8,9].includes(e)&&(b="0%");const v=(R,Y,A)=>Math.min(Math.max(R,Y),A);let N=g*this.scriptScaleX,z=M*this.scriptScaleY;const K=Math.floor(this.dummyVideo.containerWidth||0),J=Math.floor(this.dummyVideo.containerHeight||0);if(K>0&&J>0){let R=o?parseFloat(o.Fontsize):20;const Y=t.Text.match(/\\fs(\d+(\.\d+)?)/);Y&&(R=parseFloat(Y[1])),(!Number.isFinite(R)||R<=0)&&(R=20);let A=o?parseFloat(o.ScaleX||100)/100:1,_=o?parseFloat(o.ScaleY||100)/100:1;const Z=t.Text.match(/\\fscx(\d+(\.\d+)?)/),U=t.Text.match(/\\fscy(\d+(\.\d+)?)/);Z&&(A=parseFloat(Z[1])/100),U&&(_=parseFloat(U[1])/100),(!Number.isFinite(A)||A<=0)&&(A=1),(!Number.isFinite(_)||_<=0)&&(_=1);const et=R*this.fontScaleFactor*_;let H=(t.Text||"").replace(/\{[^}]*\}/g,"");H=H.replace(/\\h/g," "),H=H.replace(/\\N/g,`
`),H=H.replace(/\\n/g,`
`);const n=H.split(`
`),a=Math.max(1,n.length),c=o?String(o.Bold)==="-1":!1,d=o?String(o.Italic)==="-1":!1,m=o&&o.Fontname||"Arial",f=c?700:400,C=d?"italic":"normal";if(!this._assMeasureCtx){const nt=document.createElement("canvas");this._assMeasureCtx=nt.getContext("2d")}let y=0;if(this._assMeasureCtx){this._assMeasureCtx.font=`${C} ${f} ${Math.max(1,et)}px ${this.getFontFamilyStack(m)}`;for(const nt of n){const ct=this._assMeasureCtx.measureText(nt||"").width||0;ct>y&&(y=ct)}}(!Number.isFinite(y)||y<=0)&&(y=Math.max(1,...n.map(nt=>(nt||"").length))*Math.max(1,et)*.7);const T=y*A,F=a*et*1.35,u=o?parseFloat(o.Outline):2,k=o?parseFloat(o.Shadow):2,I=(Number.isFinite(u)?u:0)*Math.max(this.scriptScaleX,this.scriptScaleY)+(Number.isFinite(k)?k:0)*Math.max(this.scriptScaleX,this.scriptScaleY),L=Math.max(2,Math.round(et*.15)),O=Math.max(1,T+I*2+L*2),P=Math.max(1,F+I*2+L*2),W=r==="0%"?0:r==="-100%"?1:.5,D=b==="0%"?0:b==="-100%"?1:.5,X=Math.max(1,K-L*2),Q=Math.max(1,J-L*2),$=Math.min(1,X/O,Q/P),p=O*$,x=P*$,E=L*$,G=W*p+E,tt=K-(1-W)*p-E,it=D*x+E,lt=J-(1-D)*x-E;if(Number.isFinite(G)&&Number.isFinite(tt)&&G<=tt&&(N=v(N,G,tt)),Number.isFinite(it)&&Number.isFinite(lt)&&it<=lt&&(z=v(z,it,lt)),Number.isFinite(G)&&Number.isFinite(tt)&&G>tt&&(N=W===0?E:W===1?K-E:K/2),Number.isFinite(it)&&Number.isFinite(lt)&&it>lt&&(z=D===0?E:D===1?J-E:J/2),$<1){const nt=W===0?"0%":W===1?"100%":"50%",ct=D===0?"0%":D===1?"100%":"50%";s.transformOrigin=`${nt} ${ct}`,s.transform=`translate(${r}, ${b}) scale(${$})`}}s.left=`${N}px`,s.top=`${z}px`,s.width="max-content",s.transform||(s.transform=`translate(${r}, ${b})`),[1,4,7].includes(e)&&(s.textAlign="left"),[3,6,9].includes(e)&&(s.textAlign="right");const B=t.Text.match(/\\org\s*\(\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*\)/);if(B){const R=parseFloat(B[1])*this.scriptScaleX,Y=parseFloat(B[3])*this.scriptScaleY;e===7&&(s.transformOrigin=`${R-N}px ${Y-z}px`)}}else{let g=parseInt(t.MarginL,10)||0,M=parseInt(t.MarginR,10)||0,r=parseInt(t.MarginV,10)||0;o&&(g===0&&(g=parseInt(o.MarginL,10)||0),M===0&&(M=parseInt(o.MarginR,10)||0),r===0&&(r=parseInt(o.MarginV,10)||0)),s.left=`${g*this.scriptScaleX}px`,s.right=`${M*this.scriptScaleX}px`,s.width="auto";const b=(B,R,Y)=>Math.min(Math.max(B,R),Y),v=Math.floor(this.dummyVideo.containerHeight||0),N=Math.floor(this.dummyVideo.containerWidth||0),z=N>0?Math.max(1,N-(g+M)*this.scriptScaleX):0,K=B=>{let R=o?parseFloat(o.Fontsize):20;const Y=B.Text.match(/\\fs(\d+(\.\d+)?)/);Y&&(R=parseFloat(Y[1])),(!Number.isFinite(R)||R<=0)&&(R=20);let A=o?parseFloat(o.ScaleY||100)/100:1;const _=B.Text.match(/\\fscy(\d+(\.\d+)?)/);_&&(A=parseFloat(_[1])/100),(!Number.isFinite(A)||A<=0)&&(A=1);const Z=R*this.fontScaleFactor*A;let U=(B.Text||"").replace(/\{[^}]*\}/g,"");U=U.replace(/\\h/g," "),U=U.replace(/\\N/g,`
`),U=U.replace(/\\n/g,`
`);const et=U.split(`
`),H=Math.max(1,et.length),n=o?String(o.Bold)==="-1":!1,a=o?String(o.Italic)==="-1":!1,c=o&&o.Fontname||"Arial",d=n?700:400,m=a?"italic":"normal";if(!this._assMeasureCtx){const k=document.createElement("canvas");this._assMeasureCtx=k.getContext("2d")}let f=0;if(this._assMeasureCtx){this._assMeasureCtx.font=`${m} ${d} ${Math.max(1,Z)}px ${this.getFontFamilyStack(c)}`;for(const k of et){const I=this._assMeasureCtx.measureText(k||"").width||0;I>f&&(f=I)}}(!Number.isFinite(f)||f<=0)&&(f=Math.max(1,...et.map(k=>(k||"").length))*Math.max(1,Z)*.7);let C=H;z>0&&(C=Math.max(H,Math.ceil(f/z)));const y=o?parseFloat(o.Outline):2,T=o?parseFloat(o.Shadow):2,F=(Number.isFinite(y)?y:0)*Math.max(this.scriptScaleX,this.scriptScaleY)+(Number.isFinite(T)?T:0)*Math.max(this.scriptScaleX,this.scriptScaleY),u=Math.max(1,C*Z*1.35+F*2);return Math.ceil(u)},J=B=>{const R=this.activeSubtitles||[],Y=R.indexOf(t);if(Y<=0)return 0;let A=0;for(let _=0;_<Y;_++){const Z=R[_];if(!Z||Z===t)continue;const U=Z.Text||"";if(/\\pos\s*\(/.test(U)||/\\move\s*\(/.test(U))continue;let H=2;const n=this.styles.find(d=>d.Name===Z.Style);n&&(H=parseInt(n.Alignment));const a=U.match(/\\an([1-9])/);if(a&&(H=parseInt(a[1])),!a){const d=U.match(/\\a(\d+)/);if(d){const m=parseInt(d[1]),f={1:1,2:2,3:3,5:7,6:8,7:9,9:4,10:5,11:6};f[m]&&(H=f[m])}}(B==="top"?[7,8,9].includes(H):[1,2,3].includes(H))&&(A+=K(Z))}return A};if([7,8,9].includes(e)){const B=r*this.scriptScaleY,R=J("top");s.top=`${B+R}px`,s.bottom="auto"}else if([4,5,6].includes(e))s.top="50%",s.transform="translateY(-50%)";else{const B=r*this.scriptScaleY,R=J("bottom"),Y=v>0?b(B+R,0,v):B+R;s.bottom=`${Y}px`,s.top="auto"}[1,4,7].includes(e)&&(s.textAlign="left"),[3,6,9].includes(e)&&(s.textAlign="right")}return s},getRenderedParts(t){if(!t)return{parts:[],clip:null};if(this.libassPartsEnabled)return this.renderLibassWasmParts(),{parts:[],clip:null};const s=[],e=t.Style,i=V(t.Start),l=V(t.End)-i,w=this.currentTime-i,h=this.styles.find(n=>n.Name===e)||{Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF",SecondaryColour:"&H0000FFFF",OutlineColour:"&H00000000",BackColour:"&H00000000",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2"},S=n=>{if(!n)return{r:255,g:255,b:255};let a=n.replace(/&H|&/g,"");if(a.length>=8&&(a=a.substring(2)),a.length>=6){const c=parseInt(a.substring(0,2),16)||0,d=parseInt(a.substring(2,4),16)||0;return{r:parseInt(a.substring(4,6),16)||0,g:d,b:c}}return{r:255,g:255,b:255}},g=n=>{if(!n)return 0;const a=n.replace(/&H|&/g,"");if(a.length>=8){const c=parseInt(a.substring(0,2),16);return isNaN(c)?0:c/255}if(a.length<=2){const c=parseInt(a,16);return isNaN(c)?0:c/255}return 0},M=n=>({fontName:n.Fontname,fontSize:parseFloat(n.Fontsize),c1:S(n.PrimaryColour),a1:g(n.PrimaryColour),c2:S(n.SecondaryColour||"&H0000FFFF"),a2:g(n.SecondaryColour||"&H0000FFFF"),c3:S(n.OutlineColour||"&H00000000"),a3:g(n.OutlineColour||"&H00000000"),c4:S(n.BackColour||"&H00000000"),a4:g(n.BackColour||"&H00000000"),bold:n.Bold==="-1",weight:n.Bold==="-1"?700:400,italic:n.Italic==="-1",underline:n.Underline==="-1",strikeout:n.StrikeOut==="-1",scaleX:parseFloat(n.ScaleX||100)/100,scaleY:parseFloat(n.ScaleY||100)/100,spacing:parseFloat(n.Spacing||0),angleZ:parseFloat(n.Angle||0),angleX:0,angleY:0,skewX:0,skewY:0,outlineX:parseFloat(n.Outline),outlineY:parseFloat(n.Outline),shadowX:parseFloat(n.Shadow),shadowY:parseFloat(n.Shadow),blur:0,borderStyle:parseInt(n.BorderStyle||1),karaokeMode:null,karaokeNextDuration:null,karaokeCursor:0,wrapStyle:0,pMode:0,pbo:0,simpleFade:null,complexFade:null,transforms:[]});let r=M(h),b=null;const v=/({[^}]*})|([^{]+)/g,N=t.Text.match(v)||[],z=n=>Math.max(0,Math.min(1,n)),K=(n,a,c)=>n+(a-n)*c,J=n=>{const a=[];let c=0;for(;c<n.length;){if(n[c]!=="\\"){c+=1;continue}c+=1;let d="";c<n.length&&/[1-4]/.test(n[c])&&(d=n[c],c+=1);let m="";for(;c<n.length&&/[A-Za-z]/.test(n[c]);)m+=n[c],c+=1;if(!m)continue;const f=`${d}${m}`;let C="";if(c<n.length&&n[c]==="("){const y=c;let T=0;for(;c<n.length;){const F=n[c];if(F==="(")T+=1;else if(F===")"&&(T-=1,T===0)){c+=1;break}c+=1}C=n.slice(y,c).trim()}else{const y=c;for(;c<n.length&&n[c]!=="\\";)c+=1;C=n.slice(y,c).trim()}a.push({tag:f,arg:C})}return a},B=n=>({...n,c1:{...n.c1},c2:{...n.c2},c3:{...n.c3},c4:{...n.c4},simpleFade:n.simpleFade?{...n.simpleFade}:null,complexFade:n.complexFade?{...n.complexFade}:null,transforms:Array.isArray(n.transforms)?n.transforms.slice():[]}),R=n=>({fontSize:n.fontSize,scaleX:n.scaleX,scaleY:n.scaleY,spacing:n.spacing,angleX:n.angleX,angleY:n.angleY,angleZ:n.angleZ,skewX:n.skewX,skewY:n.skewY,outlineX:n.outlineX,outlineY:n.outlineY,shadowX:n.shadowX,shadowY:n.shadowY,blur:n.blur,c1:{...n.c1},c2:{...n.c2},c3:{...n.c3},c4:{...n.c4},a1:n.a1,a2:n.a2,a3:n.a3,a4:n.a4}),Y=(n,a,c,d)=>{switch(a){case"fn":n.fontName=d?h.Fontname:c;break;case"fs":n.fontSize=parseFloat(d?h.Fontsize:c);break;case"fscx":n.scaleX=parseFloat(d?h.ScaleX||100:c)/100;break;case"fscy":n.scaleY=parseFloat(d?h.ScaleY||100:c)/100;break;case"fsp":n.spacing=parseFloat(d?h.Spacing||0:c);break;case"frx":n.angleX=d?0:parseFloat(c);break;case"fry":n.angleY=d?0:parseFloat(c);break;case"frz":case"fr":n.angleZ=parseFloat(d?h.Angle||0:c);break;case"fax":n.skewX=d?0:parseFloat(c);break;case"fay":n.skewY=d?0:parseFloat(c);break;case"c":case"1c":n.c1=S(d?h.PrimaryColour:c);break;case"2c":n.c2=S(d?h.SecondaryColour:c);break;case"3c":n.c3=S(d?h.OutlineColour:c);break;case"4c":n.c4=S(d?h.BackColour:c);break;case"alpha":{const m=d?0:g(c);n.a1=n.a2=n.a3=n.a4=m;break}case"1a":n.a1=g(d?h.PrimaryColour:c);break;case"2a":n.a2=g(d?h.SecondaryColour:c);break;case"3a":n.a3=g(d?h.OutlineColour:c);break;case"4a":n.a4=g(d?h.BackColour:c);break;case"bord":if(d)n.outlineX=n.outlineY=parseFloat(h.Outline);else{const m=parseFloat(c);n.outlineX=n.outlineY=m}break;case"xbord":n.outlineX=parseFloat(d?h.Outline:c);break;case"ybord":n.outlineY=parseFloat(d?h.Outline:c);break;case"shad":if(d)n.shadowX=n.shadowY=parseFloat(h.Shadow);else{const m=parseFloat(c);n.shadowX=n.shadowY=m}break;case"xshad":n.shadowX=parseFloat(d?h.Shadow:c);break;case"yshad":n.shadowY=parseFloat(d?h.Shadow:c);break;case"be":case"blur":n.blur=d?0:parseFloat(c);break;case"b":if(d)n.bold=h.Bold==="-1",n.weight=n.bold?700:400;else{const m=parseInt(c);m===0||m===1?(n.bold=m===1,n.weight=m===1?700:400):(n.weight=m,n.bold=m>=600)}break;case"i":n.italic=d?h.Italic==="-1":c==="1";break;case"u":n.underline=d?h.Underline==="-1":c==="1";break;case"s":n.strikeout=d?h.StrikeOut==="-1":c==="1";break}},A=(n,a)=>{const c=B(n),d=Array.isArray(n.transforms)?n.transforms:[];for(const m of d){const f=Number.isFinite(m.t1)?m.t1:0,C=Number.isFinite(m.t2)?m.t2:l,y=Number.isFinite(m.accel)&&m.accel>0?m.accel:1;let T=0;C<=f?T=a>=C?1:0:T=z((a-f)/(C-f)),y!==1&&(T=z(Math.pow(T,y)));const F=m.from,u=m.to;if(!F||!u)continue;const k=["fontSize","scaleX","scaleY","spacing","angleX","angleY","angleZ","skewX","skewY","outlineX","outlineY","shadowX","shadowY","blur","a1","a2","a3","a4"];for(const L of k)Number.isFinite(F[L])&&Number.isFinite(u[L])&&(c[L]=K(F[L],u[L],T));const I=["c1","c2","c3","c4"];for(const L of I)!F[L]||!u[L]||(c[L]={r:Math.round(K(F[L].r||0,u[L].r||0,T)),g:Math.round(K(F[L].g||0,u[L].g||0,T)),b:Math.round(K(F[L].b||0,u[L].b||0,T))})}return c},_=(n,a)=>{let c=1;if(n.simpleFade&&Number.isFinite(l)&&l>0){const d=Math.max(0,parseInt(n.simpleFade.fadeIn||0,10)||0),m=Math.max(0,parseInt(n.simpleFade.fadeOut||0,10)||0);d>0&&a<d&&(c*=z(a/d)),m>0&&a>l-m&&(c*=z((l-a)/m))}if(n.complexFade){const d=n.complexFade,m=Math.max(0,Math.min(255,parseInt(d.a1,10))),f=Math.max(0,Math.min(255,parseInt(d.a2,10))),C=Math.max(0,Math.min(255,parseInt(d.a3,10))),y=Math.max(0,parseInt(d.t1,10)),T=Math.max(0,parseInt(d.t2,10)),F=Math.max(0,parseInt(d.t3,10)),u=Math.max(0,parseInt(d.t4,10));let k=m;a<y?k=m:a<T?k=T===y?f:K(m,f,z((a-y)/(T-y))):a<F?k=f:a<u?k=u===F?C:K(f,C,z((a-F)/(u-F))):k=C,c*=z(1-k/255)}return z(c)},Z=n=>{if(!n)return null;let a=n.trim();if(a.startsWith("(")&&a.endsWith(")")&&(a=a.slice(1,-1)),a=a.trim(),!a||/[A-Za-z]/.test(a))return null;const c=a.match(/-?\d+/g);if(!c||c.length!==4)return null;const d=c.map(I=>parseInt(I,10));if(d.some(I=>!Number.isFinite(I)))return null;const[m,f,C,y]=d,T=Math.min(m,C)*this.scriptScaleX,F=Math.min(f,y)*this.scriptScaleY,u=Math.abs(C-m)*this.scriptScaleX,k=Math.abs(y-f)*this.scriptScaleY;return!(u>0)||!(k>0)?null:{kind:"rect",x:T,y:F,w:u,h:k}},U=(n,a,c)=>{const d=(n||"").trim();if(!d)return"";const m=Number.isFinite(a)&&a>0?a:1,f=Number.isFinite(c)?c:0,C=d.match(/[A-Za-z]|-?\d+(?:\.\d+)?/g)||[];let y=0,T="",F="",u=0,k=0,I=!1,L=!1,O=null,P=[];const W=$=>typeof $=="string"&&/^[A-Za-z]$/.test($),D=()=>{for(;y<C.length&&W(C[y]);)return null;if(y>=C.length)return null;const $=parseFloat(C[y]);return y+=1,Number.isFinite($)?$:null},X=()=>{const $=D(),p=D();return!Number.isFinite($)||!Number.isFinite(p)?null:{x:$/m*this.scriptScaleX,y:(p+f)/m*this.scriptScaleY}},Q=$=>{if(!$)return;P.push($);const p=P.length;if(p<3)return;const x=P[p-3],E=P[p-2],G=P[p-1];T+=` C ${x.x} ${x.y} ${E.x} ${E.y} ${G.x} ${G.y}`,u=G.x,k=G.y,I=!0};for(;y<C.length;){const $=C[y];if(W($))F=String($).toLowerCase(),y+=1;else if(!F){y+=1;continue}if(F==="m"||F==="n"){L=!1,O=null,P=[];const p=X();if(!p)continue;T+=(T?" ":"")+`M ${p.x} ${p.y}`,u=p.x,k=p.y,I=!0;continue}if(F==="l"){for(L=!1,O=null,P=[];y<C.length&&!W(C[y]);){const p=X();if(!p)break;T+=` L ${p.x} ${p.y}`,u=p.x,k=p.y,I=!0}continue}if(F==="b"){for(L=!1,O=null,P=[];y<C.length&&!W(C[y]);){const p=X(),x=X(),E=X();if(!p||!x||!E)break;T+=` C ${p.x} ${p.y} ${x.x} ${x.y} ${E.x} ${E.y}`,u=E.x,k=E.y,I=!0}continue}if(F==="s"){I||(u=0,k=0,I=!0),L=!0,O={x:u,y:k},P=[];const p=[];for(;y<C.length&&!W(C[y]);){const x=X();if(!x)break;p.push(x)}if(p.length>=3){T+=` C ${p[0].x} ${p[0].y} ${p[1].x} ${p[1].y} ${p[2].x} ${p[2].y}`,u=p[2].x,k=p[2].y,I=!0,P=p.slice();for(let x=3;x<p.length;x+=1){const E=p[x-2],G=p[x-1],tt=p[x];T+=` C ${E.x} ${E.y} ${G.x} ${G.y} ${tt.x} ${tt.y}`,u=tt.x,k=tt.y,I=!0}}continue}if(F==="p"){if(!L){const x=X();if(!x)continue;T+=` L ${x.x} ${x.y}`,u=x.x,k=x.y,I=!0;continue}const p=X();if(!p)continue;Q(p);continue}if(F==="c"){L&&O&&P.length>=2&&(Q({x:O.x,y:O.y}),Q({x:P[0].x,y:P[0].y}),Q({x:P[1].x,y:P[1].y}),L=!1,O=null,P=[]);continue}}return T.trim()},et=n=>{if(!n)return null;let a=n.trim();if(a.startsWith("(")&&a.endsWith(")")&&(a=a.slice(1,-1)),a=a.trim(),!a)return null;let c=1,d=a;const m=a.indexOf(",");if(m!==-1){const C=a.slice(0,m).trim(),y=a.slice(m+1).trim();if(/^-?\d+(?:\.\d+)?$/.test(C)&&/[A-Za-z]/.test(y)){const T=parseFloat(C);Number.isFinite(T)&&T>0&&(c=T),d=y}}if(!/[A-Za-z]/.test(d))return null;const f=U(d,c,0);return f?{kind:"path",d:f}:null},H=(n,a,c)=>{if(c)return null;const d=Z(a);if(d)return{...d,invert:n==="iclip"};const m=et(a);return m?{...m,invert:n==="iclip"}:null};for(const n of N)if(n.startsWith("{")){const a=n.slice(1,-1),c=J(a);for(const d of c){const m=d.tag;let f=d.arg?d.arg.trim():"";const C=f==="";switch(m){case"fn":r.fontName=C?h.Fontname:f;break;case"fs":r.fontSize=parseFloat(C?h.Fontsize:f);break;case"fscx":r.scaleX=parseFloat(C?h.ScaleX||100:f)/100;break;case"fscy":r.scaleY=parseFloat(C?h.ScaleY||100:f)/100;break;case"fsp":r.spacing=parseFloat(C?h.Spacing||0:f);break;case"frx":r.angleX=C?0:parseFloat(f);break;case"fry":r.angleY=C?0:parseFloat(f);break;case"frz":case"fr":r.angleZ=parseFloat(C?h.Angle||0:f);break;case"fax":r.skewX=C?0:parseFloat(f);break;case"fay":r.skewY=C?0:parseFloat(f);break;case"c":case"1c":C?r.c1=S(h.PrimaryColour):r.c1=S(f);break;case"2c":C?r.c2=S(h.SecondaryColour):r.c2=S(f);break;case"3c":C?r.c3=S(h.OutlineColour):r.c3=S(f);break;case"4c":C?r.c4=S(h.BackColour):r.c4=S(f);break;case"alpha":const y=C?0:g(f);r.a1=r.a2=r.a3=r.a4=y;break;case"1a":r.a1=g(C?h.PrimaryColour:f);break;case"2a":r.a2=g(C?h.SecondaryColour:f);break;case"3a":r.a3=g(C?h.OutlineColour:f);break;case"4a":r.a4=g(C?h.BackColour:f);break;case"b":if(C)r.bold=h.Bold==="-1",r.weight=r.bold?700:400;else{const u=parseInt(f);u===0||u===1?(r.bold=u===1,r.weight=u===1?700:400):(r.weight=u,r.bold=u>=600)}break;case"i":r.italic=C?h.Italic==="-1":f==="1";break;case"u":r.underline=C?h.Underline==="-1":f==="1";break;case"s":r.strikeout=C?h.StrikeOut==="-1":f==="1";break;case"bord":if(C)r.outlineX=r.outlineY=parseFloat(h.Outline);else{const u=parseFloat(f);r.outlineX=r.outlineY=u}break;case"xbord":r.outlineX=parseFloat(C?h.Outline:f);break;case"ybord":r.outlineY=parseFloat(C?h.Outline:f);break;case"shad":if(C)r.shadowX=r.shadowY=parseFloat(h.Shadow);else{const u=parseFloat(f);r.shadowX=r.shadowY=u}break;case"xshad":r.shadowX=parseFloat(C?h.Shadow:f);break;case"yshad":r.shadowY=parseFloat(C?h.Shadow:f);break;case"be":case"blur":r.blur=C?0:parseFloat(f);break;case"q":r.wrapStyle=C?0:parseInt(f);break;case"p":{if(C){r.pMode=0;break}const u=parseInt(f,10);r.pMode=Number.isFinite(u)?u:0;break}case"pbo":{if(C){r.pbo=0;break}const u=parseFloat(f);r.pbo=Number.isFinite(u)?u:0;break}case"k":case"K":case"kf":case"ko":{if(!C){const u=parseInt(f,10);isNaN(u)||(r.karaokeMode=m,r.karaokeNextDuration=u*10)}break}case"kt":{if(!C){const u=parseInt(f,10);isNaN(u)||(r.karaokeCursor=u*10)}break}case"fad":{if(C){r.simpleFade=null;break}const u=f.match(/\(\s*(\d+)\s*,\s*(\d+)\s*\)/);u&&(r.simpleFade={fadeIn:parseInt(u[1],10),fadeOut:parseInt(u[2],10)});break}case"fade":{if(C){r.complexFade=null;break}const u=f.match(/\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);u&&(r.complexFade={a1:parseInt(u[1],10),a2:parseInt(u[2],10),a3:parseInt(u[3],10),t1:parseInt(u[4],10),t2:parseInt(u[5],10),t3:parseInt(u[6],10),t4:parseInt(u[7],10)});break}case"t":{if(C)break;let u=f;u.startsWith("(")&&u.endsWith(")")&&(u=u.slice(1,-1));const k=u.indexOf("\\");if(k===-1)break;const I=u.slice(0,k).trim().replace(/,+\s*$/,""),L=u.slice(k),O=I?I.split(",").map(x=>x.trim()).filter(Boolean):[];let P=0,W=l,D=1;O.length===1?D=parseFloat(O[0]):O.length===2?(P=parseFloat(O[0]),W=parseFloat(O[1])):O.length>=3&&(P=parseFloat(O[0]),W=parseFloat(O[1]),D=parseFloat(O[2]));const X=R(r),Q=B(r),$=J(L);for(const x of $)Y(Q,x.tag,(x.arg||"").trim(),(x.arg||"").trim()==="");const p=R(Q);r.transforms.push({t1:Number.isFinite(P)?P:0,t2:Number.isFinite(W)?W:l,accel:Number.isFinite(D)?D:1,from:X,to:p});break}case"clip":case"iclip":{if(C){b=null;break}const u=H(m,f,C);u&&(b=u);break}case"r":const T=f||e,F=this.styles.find(u=>u.Name===T)||h;r=M(F);break}}}else{const a=A(r,w),c=_(a,w);let d="";r.underline&&(d+="underline "),r.strikeout&&(d+="line-through");const m=a.fontSize*this.fontScaleFactor;let f=n;f=f.replace(/\\h/g," "),r.wrapStyle===2?f=f.replace(/\\n/g,`
`):f=f.replace(/\\n/g," ");const C=f.replace(/\\N/g,`
`),y=a.outlineX*this.scriptScaleX,T=a.outlineY*this.scriptScaleY,F=a.shadowX*this.scriptScaleX,u=a.shadowY*this.scriptScaleY,k=a.blur*this.fontScaleFactor,I=a.spacing*this.scriptScaleX,L=(q,ot)=>`rgba(${q.r},${q.g},${q.b},${1-ot})`,O=L(a.c1,a.a1),P=L(a.c2,a.a2),W=L(a.c3,a.a3),D=L(a.c4,a.a4);let X=O,Q=y,$=T,p=null;if(r.karaokeNextDuration!==null&&r.karaokeMode){const q=r.karaokeCursor,ot=r.karaokeNextDuration,dt=q+ot,at=ot>0?(w-q)/ot:1;if(r.karaokeMode==="k"||r.karaokeMode==="ko")X=w<q?P:O,r.karaokeMode==="ko"&&w<q&&(Q=0,$=0);else if(r.karaokeMode==="K"||r.karaokeMode==="kf")if(at<=0)X=P;else if(at>=1)X=O;else{const yt=Math.max(0,Math.min(1,at))*100;p=`linear-gradient(90deg, ${O} ${yt}%, ${P} ${yt}%)`,X="transparent"}r.karaokeCursor=dt,r.karaokeNextDuration=null,r.karaokeMode=null}const x=r.borderStyle===3,E=x?void 0:this.generateShadow(Q,$,F,u,W,D,k),G=!x&&Q===0&&$===0&&k>0,tt=G?"transparent":X;let it=E;if(G){const q=`0 0 ${k}px ${X}`;it=it?`${q}, ${it}`:q}const lt=x?Math.max(0,Q):0,nt=x?Math.max(0,$):0,ct=x&&(F!==0||u!==0||k>0)?`${F}px ${u}px ${k}px ${D}`:void 0;let rt=[];a.angleX&&rt.push(`rotateX(${a.angleX}deg)`),a.angleY&&rt.push(`rotateY(${a.angleY}deg)`),a.angleZ&&rt.push(`rotateZ(${-a.angleZ}deg)`),(a.scaleX!==1||a.scaleY!==1)&&rt.push(`scale(${a.scaleX}, ${a.scaleY})`),a.skewX&&rt.push(`skewX(${-Math.atan(a.skewX)}rad)`),a.skewY&&rt.push(`skewY(${-Math.atan(a.skewY)}rad)`);const ut=rt.length?rt.join(" "):void 0;if(Number.isFinite(r.pMode)&&r.pMode>0){const q=Math.max(1,Math.floor(r.pMode)),ot=Math.pow(2,q-1),dt=U(n,ot,r.pbo);if(dt){const at=Math.max(0,(Q+$)/2);s.push({kind:"drawing",d:dt,fill:O,stroke:at>0?W:void 0,strokeWidth:at>0?at:void 0,style:{display:"inline-block",overflow:"visible",transform:ut,transformOrigin:ut?"0 0":void 0,opacity:c!==1?c:void 0}})}continue}x?s.push({text:C,style:{fontFamily:this.getFontFamilyStack(r.fontName),fontSize:`${m}px`,lineHeight:1.35,color:tt,fontWeight:r.weight,fontStyle:r.italic?"italic":"normal",textDecoration:d.trim(),whiteSpace:r.wrapStyle===2?"pre":"pre-wrap",letterSpacing:I?`${I}px`:void 0,display:"inline-block",backgroundColor:W,padding:`${nt}px ${lt}px`,boxShadow:ct,transform:ut,transformOrigin:ut?"50% 50%":void 0,opacity:c!==1?c:void 0}}):C.split(`
`).forEach((ot,dt)=>{dt>0&&s.push({text:`
`,style:{whiteSpace:r.wrapStyle===2?"pre":"pre-wrap"}}),ot&&s.push({text:ot,style:{fontFamily:this.getFontFamilyStack(r.fontName),fontSize:`${m}px`,lineHeight:1.35,color:tt,fontWeight:r.weight,fontStyle:r.italic?"italic":"normal",textDecoration:d.trim(),textShadow:it,whiteSpace:r.wrapStyle===2?"pre":"pre-wrap",letterSpacing:I?`${I}px`:void 0,transform:ut,display:ut||p?"inline-block":void 0,transformOrigin:"50% 50%",backgroundImage:p||void 0,WebkitBackgroundClip:p?"text":void 0,backgroundClip:p?"text":void 0,WebkitTextFillColor:p?"transparent":void 0,opacity:c!==1?c:void 0}})})}return{parts:s,clip:b}},parseAssColor(t){if(!t)return"white";const s=t.replace(/&H|&/g,"");if(s.length===6){const e=parseInt(s.substring(0,2),16),i=parseInt(s.substring(2,4),16);return`rgb(${parseInt(s.substring(4,6),16)}, ${i}, ${e})`}else if(s.length>=8){const e=parseInt(s.substring(0,2),16),i=parseInt(s.substring(2,4),16),o=parseInt(s.substring(4,6),16),l=parseInt(s.substring(6,8),16),w=1-e/255;return`rgba(${l}, ${o}, ${i}, ${w})`}return"white"},generateShadow(t,s,e,i,o,l,w){let h=[];const S=o||"#000",g=l||"rgba(0,0,0,0.5)",M=w||0;if(t>0||s>0)for(let r=-1;r<=1;r++)for(let b=-1;b<=1;b++)(r!==0||b!==0)&&h.push(`${r*t}px ${b*s}px ${M}px ${S}`);return(e!==0||i!==0)&&h.push(`${e}px ${i}px ${M}px ${g}`),h.join(", ")},formatTime(t){return St(t)},parseTime(t){return V(t)},openDummyVideoOptions(){this.dummyVideo.showOptions=!0},toggleViewMode(t){this.viewMode=t},togglePlayback(){this.dummyVideo.isPlaying?this.pauseVideo():this.playVideo()},playVideo(){this.dummyVideo.isPlaying=!0,this.playbackInterval&&clearInterval(this.playbackInterval);let t=performance.now();this.playbackInterval=setInterval(()=>{const s=performance.now(),e=s-t;t=s,this.currentTime+=e;const i=this.videoDuration||0;i>0&&this.currentTime>=i&&(this.currentTime=this.currentTime%i)},16)},pauseVideo(){this.dummyVideo.isPlaying=!1,this.playbackInterval&&(clearInterval(this.playbackInterval),this.playbackInterval=null)},seek(t){this.currentTime=parseInt(t)},saveDummyOptions(){this.dummyVideo.showOptions=!1,this.resizeLibassCanvas(),this.renderLibassWasm()},saveColumnSettings(){const t={showColTime:this.showColTime,showColStyle:this.showColStyle,showColStatus:this.showColStatus,showColText:this.showColText};localStorage.setItem("lines-modal-columns",JSON.stringify(t))},saveStylesColumnSettings(){const t={showColFontname:this.showColFontname,showColFontsize:this.showColFontsize,showColPrimaryColour:this.showColPrimaryColour,showColSecondaryColour:this.showColSecondaryColour,showColOutlineColour:this.showColOutlineColour,showColBackColour:this.showColBackColour,showColBold:this.showColBold,showColItalic:this.showColItalic,showColUnderline:this.showColUnderline,showColStrikeOut:this.showColStrikeOut,showColScaleX:this.showColScaleX,showColScaleY:this.showColScaleY,showColSpacing:this.showColSpacing,showColAngle:this.showColAngle,showColBorderStyle:this.showColBorderStyle,showColOutline:this.showColOutline,showColShadow:this.showColShadow,showColAlignment:this.showColAlignment,showColMarginL:this.showColMarginL,showColMarginR:this.showColMarginR,showColMarginV:this.showColMarginV,showColEncoding:this.showColEncoding};localStorage.setItem("styles-modal-columns",JSON.stringify(t))},recheckAllLines(){this.isRechecking=!0,this.lines.forEach(t=>{t.isRTL=wt(t.Text),t.displaysRTL=ht(t.Text),t.isArabic=j(t.Text),t.hasBidiNeutral=mt(t.Text)}),this.isRechecking=!1},handleRangeInput(){const t=this.rangeInput.trim();if(!t)return;if(/^\d+$/.test(t)){const e=parseInt(t);e>=1&&e<=this.totalLines&&(this.goToLine(e-1),this.rangeInput="");return}const s=t.match(/^(\d+)-(\d+)$/);if(s){const e=parseInt(s[1]);e>=1&&e<=this.totalLines&&(this.goToLine(e-1),this.rangeInput="")}},logError(t){const s=new Date().toLocaleTimeString();this.errorLog.push(`[${s}] ${t}`),console.error(t)},clearErrorLog(){this.errorLog=[]},async loadTheme(){const t=localStorage.getItem("rtl-editor-theme");t?this.isDarkMode=t==="dark":this.isDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches,this.applyTheme()},saveTheme(){localStorage.setItem("rtl-editor-theme",this.isDarkMode?"dark":"light")},toggleTheme(){this.isDarkMode=!this.isDarkMode,this.applyTheme(),this.saveTheme()},applyTheme(){this.isDarkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")},setupSystemThemeListener(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",s=>{localStorage.getItem("rtl-editor-theme")||(this.isDarkMode=s.matches,this.applyTheme())})},setupPWAInstall(){window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),this.deferredPrompt=t,this.showInstallButton=!0}),window.addEventListener("appinstalled",()=>{this.deferredPrompt=null,this.showInstallButton=!1})},async installPWA(){if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome:t}=await this.deferredPrompt.userChoice;t==="accepted"&&(this.deferredPrompt=null,this.showInstallButton=!1)}},handleDrop(t){this.isDragging=!1;const s=t.dataTransfer.files[0];s&&s.name.endsWith(".ass")&&this.parseFile(s)},handleFileUpload(t){const s=t.target.files[0];s&&this.parseFile(s)},async parseFile(t){try{this.showResetConfirmModal=!1,this.fileName=t.name,this.fileSize=Xt(t.size);const s=await t.text(),e=s.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);let i=!1,o=!1,l=!1,w=-1;this.lines=[],this.scriptInfo=[],this.styles=[],this.overrideStats={fn:new Set,fs:new Set,colors:new Set,other:new Set};for(let S=0;S<e.length;S++){const g=e[S],M=g.trim();if(M==="[Script Info]"){o=!0,i=!1,l=!1;continue}if(M==="[V4+ Styles]"){l=!0,o=!1,i=!1;continue}if(M==="[Events]"){i=!0,o=!1,l=!1,w=S;continue}if(M.startsWith("[")&&M!=="[Events]"){o=!1,i=!1,l=!1;continue}if(o&&M.includes(":")){const r=M.split(":");if(r.length>=2){const b=r[0].trim(),v=r.slice(1).join(":").trim();this.scriptInfo.push({key:b,value:v})}}if(l&&M.startsWith("Style:")){const r=M.substring(6).split(",");r.length>=2&&this.styles.push({Name:r[0].trim(),Fontname:r[1].trim(),Fontsize:r[2].trim(),PrimaryColour:r[3].trim(),SecondaryColour:r[4].trim(),OutlineColour:r[5].trim(),BackColour:r[6].trim(),Bold:r[7].trim(),Italic:r[8].trim(),Underline:r[9].trim(),StrikeOut:r[10].trim(),ScaleX:r[11].trim(),ScaleY:r[12].trim(),Spacing:r[13].trim(),Angle:r[14].trim(),BorderStyle:r[15].trim(),Outline:r[16].trim(),Shadow:r[17].trim(),Alignment:r[18].trim(),MarginL:r[19].trim(),MarginR:r[20].trim(),MarginV:r[21].trim(),Encoding:r[22].trim()})}if(i&&M.startsWith("Dialogue:"))try{const r=zt(g);if(r){r.isRTL=wt(r.Text),r.displaysRTL=ht(r.Text);const b=Wt(r.Text);b.fn.forEach(v=>this.overrideStats.fn.add(v)),b.fs.forEach(v=>this.overrideStats.fs.add(v)),b.colors.forEach(v=>this.overrideStats.colors.add(v)),b.other.forEach(v=>this.overrideStats.other.add(v)),r.isArabic=j(r.Text),r.hasBidiNeutral=mt(r.Text),r.originalIndex=this.lines.length,this.lines.push(r)}}catch(r){this.logError(`Failed to parse line ${S+1}: ${r.message}`)}}let h="";w>0?h=e.slice(0,w+1).join(`
`)+`
`:h=s.split("[Events]")[0]+`[Events]
`,this.assFile={header:h,lines:e},this.currentIndex=0,this.updateRTLPreview(),this.originalFileSnapshot=this.createFileSnapshot(),this.syncEditedLineIndices(),this.lines.length===0&&this.logError("No dialogue lines found in the file")}catch(s){this.logError(`Failed to parse file: ${s.message}`)}},updateRTLPreview(){this.currentLine?(this.rtlPreviewText=gt(this.currentLine.Text),this.ensureRtlHistorySynced(this.currentIndex)):this.rtlPreviewText=""},createFileSnapshot(){return{header:this.assFile?this.assFile.header:"",assFileLines:this.assFile?this.assFile.lines:[],lines:this.lines.map(t=>({...t})),scriptInfo:this.scriptInfo.map(t=>({...t})),styles:this.styles.map(t=>({...t})),fileName:this.fileName,fileSize:this.fileSize,overrideStats:{fn:[...this.overrideStats.fn],fs:[...this.overrideStats.fs],colors:[...this.overrideStats.colors],other:[...this.overrideStats.other]}}},syncEditedLineIndices(){if(!this.originalFileSnapshot||!Array.isArray(this.originalFileSnapshot.lines)){this.editedLineIndices=[];return}const t=this.originalFileSnapshot.lines,s=[],e=Math.max(this.lines.length,t.length);for(let i=0;i<e;i++){const o=this.lines[i],l=t[i],w=o?String(o.Text??""):"",h=l?String(l.Text??""):"";(!o||!l||w!==h)&&s.push(i)}this.editedLineIndices=s},restoreFileSnapshot(t){t&&(this.assFile={header:t.header||"",lines:t.assFileLines||[]},this.lines=Array.isArray(t.lines)?t.lines.map(s=>({...s})):[],this.scriptInfo=Array.isArray(t.scriptInfo)?t.scriptInfo.map(s=>({...s})):[],this.styles=Array.isArray(t.styles)?t.styles.map(s=>({...s})):[],this.fileName=t.fileName||"",this.fileSize=t.fileSize||"0 Bytes",this.overrideStats={fn:new Set(t.overrideStats?.fn||[]),fs:new Set(t.overrideStats?.fs||[]),colors:new Set(t.overrideStats?.colors||[]),other:new Set(t.overrideStats?.other||[])},this.currentIndex=0,this.rtlPreviewText="",this.rtlEditHistory=Object.create(null),this.updateRTLPreview(),this.syncEditedLineIndices())},resetToOriginalFile(){this.restoreFileSnapshot(this.originalFileSnapshot)},openResetToOriginalConfirm(){this.canResetToOriginal&&(this.showResetConfirmModal=!0)},confirmResetToOriginal(){this.showResetConfirmModal=!1,this.resetToOriginalFile()},cancelResetToOriginal(){this.showResetConfirmModal=!1},createRtlSnapshot(t,s){return{lineText:String(t??""),previewText:String(s??"")}},isSameRtlSnapshot(t,s){return!!t&&!!s&&t.lineText===s.lineText&&t.previewText===s.previewText},normalizeRtlSnapshot(t){return t&&typeof t=="object"?this.createRtlSnapshot(t.lineText,t.previewText):this.createRtlSnapshot(t,t)},getRtlHistory(t,s=null){const e=String(t);if(!this.rtlEditHistory[e]){const o=s?this.normalizeRtlSnapshot(s):this.createRtlSnapshot("","");this.rtlEditHistory[e]={undo:[],redo:[],base:o,last:o}}const i=this.rtlEditHistory[e];return Array.isArray(i.undo)||(i.undo=[]),Array.isArray(i.redo)||(i.redo=[]),i.base||(i.base=i.last),i.base=this.normalizeRtlSnapshot(i.base),i.last=this.normalizeRtlSnapshot(i.last),i.undo=i.undo.map(o=>this.normalizeRtlSnapshot(o)),i.redo=i.redo.map(o=>this.normalizeRtlSnapshot(o)),i},ensureRtlHistorySynced(t){if(!this.currentLine)return null;const s=this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText),e=this.getRtlHistory(t,s);return!this.isSameRtlSnapshot(e.last,s)&&e.undo.length===0&&e.redo.length===0&&(e.last=s),e},resetRtlHistory(t,s=""){const e=String(t),i=this.normalizeRtlSnapshot(s);this.rtlEditHistory[e]={undo:[],redo:[],base:i,last:i}},applyRtlStateToCurrentLine(t){if(!this.currentLine)return;const s=this.normalizeRtlSnapshot(t);this.rtlPreviewText=s.previewText,this.currentLine.Text=s.lineText,this.currentLine.isRTL=wt(this.currentLine.Text),this.currentLine.displaysRTL=ht(this.currentLine.Text),this.currentLine.isArabic=j(this.currentLine.Text),this.currentLine.hasBidiNeutral=mt(this.currentLine.Text)},undoRtlEdit(){if(!this.currentLine)return;const t=this.ensureRtlHistorySynced(this.currentIndex);if(!t||t.undo.length===0)return;const s=t.undo.pop();t.redo.push(t.last),t.last=s,this.applyRtlStateToCurrentLine(s)},redoRtlEdit(){if(!this.currentLine)return;const t=this.ensureRtlHistorySynced(this.currentIndex);if(!t||t.redo.length===0)return;const s=t.redo.pop();t.undo.push(t.last),t.undo.length>this.rtlEditHistoryLimit&&t.undo.splice(0,t.undo.length-this.rtlEditHistoryLimit),t.last=s,this.applyRtlStateToCurrentLine(s)},resetRtlEditToBase(){if(!this.currentLine)return;const t=this.ensureRtlHistorySynced(this.currentIndex)||this.getRtlHistory(this.currentIndex);if(!t||!t.base)return;const s=this.normalizeRtlSnapshot(t.base);t.undo=[],t.redo=[],t.last=s,this.applyRtlStateToCurrentLine(s)},handleDummyVideoUnlockFirstStep(){this.showDummyVideoToggle||(this.dummyVideoUnlockStep=1)},handleDummyVideoUnlockSecondStep(){this.showDummyVideoToggle||this.dummyVideoUnlockStep===1&&(this.showDummyVideoToggle=!0,this.dummyVideoUnlockStep=0)},applyRTLConversion(){if(this.currentLine)try{const t=this.ensureRtlHistorySynced(this.currentIndex),s=t?t.last:this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText),e=this.createRtlSnapshot(this.rtlPreviewText,this.rtlPreviewText);t&&!this.isSameRtlSnapshot(s,e)&&(t.undo.push(s),t.undo.length>this.rtlEditHistoryLimit&&t.undo.splice(0,t.undo.length-this.rtlEditHistoryLimit),t.redo=[],t.last=e),this.applyRtlStateToCurrentLine(e)}catch(t){this.logError(`Failed to apply RTL conversion: ${t.message}`)}},convertRTLtoLTR(){if(this.currentLine&&this.currentLine.isRTL)try{const t=this.ensureRtlHistorySynced(this.currentIndex),s=t?t.last:this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText);this.currentLine.Text=pt(this.currentLine.Text),this.currentLine.isRTL=!1,this.currentLine.displaysRTL=ht(this.currentLine.Text),this.currentLine.isArabic=j(this.currentLine.Text),this.currentLine.hasBidiNeutral=mt(this.currentLine.Text),this.rtlPreviewText=gt(this.currentLine.Text);const e=this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText);t&&!this.isSameRtlSnapshot(s,e)&&(t.undo.push(s),t.undo.length>this.rtlEditHistoryLimit&&t.undo.splice(0,t.undo.length-this.rtlEditHistoryLimit),t.redo=[],t.last=e)}catch(t){this.logError(`Failed to convert RTL to LTR: ${t.message}`)}},convertFilteredToLTR(){const t=this.filteredLines.filter(s=>s.isRTL);this.bulkConvertLinesToConvert=t,this.bulkConvertType="ltr",this.bulkConvertProgress=0,this.bulkConvertTotal=t.length,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0,this.showBulkConvertModal=!0},convertFilteredToRTL(){const t=this.filteredLines.filter(s=>s.displaysRTL&&!s.isRTL);this.bulkConvertLinesToConvert=t,this.bulkConvertType="rtl",this.bulkConvertProgress=0,this.bulkConvertTotal=t.length,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0,this.showBulkConvertModal=!0},async performBulkConversion(){this.bulkConvertStartTime=Date.now(),this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0;const t=5;let s=0;const e=()=>new Promise(i=>{setTimeout(()=>{const o=Math.min(s+t,this.bulkConvertLinesToConvert.length);for(let l=s;l<o;l++){const w=this.bulkConvertLinesToConvert[l];try{this.bulkConvertType==="ltr"?(w.Text=pt(w.Text),w.isRTL=!1,w.displaysRTL=ht(w.Text),w.isArabic=j(w.Text)):(w.Text=gt(w.Text),w.isRTL=!0,w.displaysRTL=ht(w.Text),w.isArabic=j(w.Text)),this.bulkConvertSuccessCount++}catch(h){this.bulkConvertFailureCount++,this.logError(`Failed to convert line ${w.originalIndex+1}: ${h.message}`)}}s=o,this.bulkConvertProgress=s,s<this.bulkConvertLinesToConvert.length?e().then(i):(this.bulkConvertEndTime=Date.now(),this.bulkConvertSuccess=!0,i())},0)});await e(),this.updateRTLPreview(),this.currentLine&&this.resetRtlHistory(this.currentIndex,this.rtlPreviewText)},cancelBulkConversion(){this.showBulkConvertModal=!1,this.bulkConvertProgress=0,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0},closeBulkConvertModal(){this.showBulkConvertModal=!1,this.bulkConvertProgress=0,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0},handleRTLTextEdit(t){if(this.currentLine)try{const s=t&&t.target?String(t.target.value??""):this.rtlPreviewText;s!==this.rtlPreviewText&&(this.rtlPreviewText=s);const e=this.getRtlHistory(this.currentIndex,this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText)),i=this.createRtlSnapshot(s,s),o=e.last;this.isSameRtlSnapshot(i,o)||(e.undo.push(o),e.undo.length>this.rtlEditHistoryLimit&&e.undo.splice(0,e.undo.length-this.rtlEditHistoryLimit),e.redo=[],e.last=i),this.applyRtlStateToCurrentLine(i)}catch(s){this.logError(`Failed to update text: ${s.message}`)}},goToLine(t){if(t>=0&&t<this.lines.length){const s=this.lines[t];this.filterMode!=="all"&&(this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL||(this.filterMode="all")),this.currentIndex=t,this.updateRTLPreview(),this.showLinesModalOpen=!1}},showLinesModal(t){this.linesModalType=t,this.currentPage=1,this.showLinesModalOpen=!0},goToFirstPage(){this.currentPage=1},goToLastPage(){this.currentPage=this.totalPages},openFontsModal(){this.showFontsModal=!0},openDebugModal(){this.showDebugModal=!0,this.updateDebugInfo()},updateDebugInfo(){if(!this.currentLine)return;const t=this.currentLine.Text;this.debugLineInfo={text:t,length:t.length,hasRLE:t.includes(st),isRTL:wt(t),isArabic:j(t),startRegex:/^((?:\{[^{}]*\})*)\u202B/.test(t),newlineRegex:/(\\[Nn])((?:\{[^{}]*\})*)\u202B/.test(t),charCodes:t.split("").map(s=>"\\u"+s.charCodeAt(0).toString(16).padStart(4,"0")).join(" ")}},runDiagnostics(){let t=0,s=0,e=[],i=0,o=0;this.lines.forEach((w,h)=>{const S=wt(w.Text),g=w.Text.includes(st);g&&i++,S&&o++,w.isRTL!==S&&(e.push(`Line ${h+1}: Stored isRTL=${w.isRTL}, Calc=${S}, HasRLE=${g}`),w.isRTL?t++:s++)});const l=`Diagnostics Complete:
RLE Constant Check: OK
Total Lines: ${this.lines.length}
Lines with RLE char (Strict Check): ${i}
Lines detected as RTL (Calc): ${o}
False Positives (Stored=True, Calc=False): ${t}
False Negatives (Stored=False, Calc=True): ${s}

Details (First 10):
${e.slice(0,10).join(`
`)}`;alert(l),console.log(l)},jumpToLine(){const t=parseInt(this.jumpToLineNumber);!isNaN(t)&&t>=1&&t<=this.lines.length&&(this.goToLine(t-1),this.jumpToLineNumber="")},goToFirstLine(){if(this.viewMode==="dummy-video"){const t=i=>this.filterMode==="all"||this.filterMode==="rtl"&&i.displaysRTL||this.filterMode==="needsrtl"&&i.isArabic&&!i.isRTL||this.filterMode==="ltr"&&!i.displaysRTL;let s=-1,e=1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=V(o.Start);l<e&&(e=l,s=i)}s!==-1&&(this.currentIndex=s,this.currentTime=e,this.updateRTLPreview());return}this.currentIndex=-1,this.goToNextLine(),this.currentIndex===-1&&this.updateRTLPreview()},goToPreviousLine(){if(this.viewMode==="dummy-video"){const s=l=>this.filterMode==="all"||this.filterMode==="rtl"&&l.displaysRTL||this.filterMode==="needsrtl"&&l.isArabic&&!l.isRTL||this.filterMode==="ltr"&&!l.displaysRTL,e=this.currentTime||0;let i=-1,o=-1/0;for(let l=0;l<this.lines.length;l++){const w=this.lines[l];if(!s(w))continue;const h=V(w.End);h<e&&h>o&&(o=h,i=l)}i!==-1&&(this.currentIndex=i,this.currentTime=V(this.lines[i].Start),this.updateRTLPreview());return}let t=this.currentIndex-1;for(;t>=0;){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}t--}},goToNextLine(){if(this.viewMode==="dummy-video"){const s=l=>this.filterMode==="all"||this.filterMode==="rtl"&&l.displaysRTL||this.filterMode==="needsrtl"&&l.isArabic&&!l.isRTL||this.filterMode==="ltr"&&!l.displaysRTL,e=this.currentTime||0;let i=-1,o=1/0;for(let l=0;l<this.lines.length;l++){const w=this.lines[l];if(!s(w))continue;const h=V(w.Start);h>e&&h<o&&(o=h,i=l)}i!==-1&&(this.currentIndex=i,this.currentTime=o,this.updateRTLPreview());return}let t=this.currentIndex+1;for(;t<this.lines.length;){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}t++}},goToLastLine(){if(this.viewMode==="dummy-video"){const t=i=>this.filterMode==="all"||this.filterMode==="rtl"&&i.displaysRTL||this.filterMode==="needsrtl"&&i.isArabic&&!i.isRTL||this.filterMode==="ltr"&&!i.displaysRTL;let s=-1,e=-1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=V(o.Start);l>e&&(e=l,s=i)}s!==-1&&(this.currentIndex=s,this.currentTime=e,this.updateRTLPreview());return}for(let t=this.lines.length-1;t>=0;t--){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}}this.currentIndex=-1,this.updateRTLPreview()},bulkConvertToRTL(){const t=this.lines.filter(s=>!s.displaysRTL);t.length!==0&&(this.bulkConvertLinesToConvert=t,this.bulkConvertType="rtl",this.bulkConvertProgress=0,this.bulkConvertTotal=t.length,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0,this.showBulkConvertModal=!0)},exportAssFile(){try{let t=this.assFile.header;t+=`Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\r
`;for(const o of this.lines)t+=`Dialogue: ${o.Layer},${o.Start},${o.End},${o.Style},${o.Name},${o.MarginL},${o.MarginR},${o.MarginV},${o.Effect},${o.Text}\r
`;const s=new Blob([t],{type:"text/plain;charset=utf-8"}),e=URL.createObjectURL(s),i=document.createElement("a");i.href=e,i.download=this.fileName.replace(".ass","_RTL.ass"),i.click(),URL.revokeObjectURL(e)}catch(t){this.logError(`Failed to export file: ${t.message}`)}},setupResizeObserver(){this.$nextTick(()=>{if(this.$refs.videoContainer){this.resizeObserver&&this.resizeObserver.disconnect();const t=this.$refs.videoContainer.getBoundingClientRect();this.dummyVideo.containerWidth=t.width,this.dummyVideo.containerHeight=t.height,this.resizeLibassCanvas(),this.resizeLibassPartsCanvas(),this.renderLibassWasm(),this.renderLibassWasmParts(),this.resizeObserver=new ResizeObserver(s=>{for(const e of s)this.dummyVideo.containerWidth=e.contentRect.width,this.dummyVideo.containerHeight=e.contentRect.height,this.resizeLibassCanvas(),this.resizeLibassPartsCanvas(),this.renderLibassWasm(),this.renderLibassWasmParts()}),this.resizeObserver.observe(this.$refs.videoContainer)}})},cleanupResizeObserver(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},resetFile(){this.disposeLibassWasm(),this.disposeLibassWasmParts(),this.libassPartsFailed=!1,this.showResetConfirmModal=!1,this.assFile=null,this.originalFileSnapshot=null,this.lines=[],this.editedLineIndices=[],this.fileName="",this.fileSize="0 Bytes",this.isProcessing=!1,this.currentIndex=0,this.rtlPreviewText="",this.rtlEditHistory=Object.create(null),this.errorLog=[],this.scriptInfo=[],this.styles=[],this.dummyVideo.containerWidth=0,this.dummyVideo.containerHeight=0,this.overrideStats={fn:new Set,fs:new Set,colors:new Set,other:new Set},this.$refs.fileInput&&(this.$refs.fileInput.value="")}}});Vt.mount("#app");"serviceWorker"in navigator&&window.addEventListener("load",()=>{const t=new URL("service-worker.js",new URL(".",window.location.href));navigator.serviceWorker.register(t.toString()).then(s=>{console.log("Service Worker registered: ",s)}).catch(s=>{console.log("Service Worker registration failed: ",s)})});
