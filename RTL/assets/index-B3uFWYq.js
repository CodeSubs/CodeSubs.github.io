import Ct from"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/+esm";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function e(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(o){if(o.ep)return;o.ep=!0;const l=e(o);fetch(o.href,l)}})();const st="‫";function H(t){return/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(t)}const ft=/^[\s\u061C\u200E\u200F!"#$%&'()*+,\-./:;<=>?@\[\\\]^_`{|}~،؛؟«»ـ…]+/;function Mt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft),l=o?o[0]:"";return i=i.slice(l.length),i.startsWith(st)}function mt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft);return o?(i=i.slice(o[0].length),H(i)):!1}function vt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return!H(i)||/\{[^{}]*\\alpha&HFF[^{}]*\}\s*[!.?…،.]+$/.test(i)?!1:(i=i.replace(/[\s\u061C\u200E\u200F"«»“”„'`]+$/,""),/[!.?…،:]$/.test(i))}function Rt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/);return(s?s[0]:"").length>0}function It(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"",i=t.slice(e.length);return/^\s*\d+[.)]\s+/.test(i)}function Pt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"",i=t.slice(e.length);if(!/^\s*["«»“”„]/.test(i))return!1;const o=i.match(/["«»“”„]/g);return o&&o.length===1}function $t(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";return t.slice(e.length).includes("!")}function Ot(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft),l=o?o[0]:"";return i=i.slice(l.length),H(i)}function Bt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return H(i)?(i=i.replace(/[\s\u061C\u200E\u200F"«»“”„'`]+$/,""),/[!؟][؟!]$/.test(i)):!1}function At(t){return!t||typeof t!="string"?!1:/\\[Nn]/.test(t)}function Et(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);if(!i.startsWith("!"))return!1;i=i.slice(1);const o=i.match(ft),l=o?o[0]:"";return i=i.slice(l.length),H(i)}function bt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"",i=t.slice(e.length);if(!i)return!1;const o=i[0];return/["«»“”„]/.test(o)}function Nt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return!H(i)||/[،؛؟]["'«»“”„]\s*$/.test(i)?!1:(i=i.replace(/[\s\u061C\u200E\u200F"«»“”„'`]+$/,""),/[!.?…،؛؟]$/.test(i))}function _t(t){if(!t||typeof t!="string")return!1;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);return/[،؛؟]["'«»“”„]\s*$/.test(i)}function Lt(t){if(!t||typeof t!="string"||t.indexOf(st)===-1)return!1;const s=t.split(/(\\[Nn])/);for(let e=0;e<s.length;e+=2)if(Mt(s[e]))return!0;return!1}function Tt(t){if(!t||typeof t!="string")return null;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/,l=/[a-zA-Z]/,u=/[\u0590-\u05FF]/,a=/[\s!"#$%&'()*+,\-./:;<=>?@\[\\\]^_`{|}~،؛؟«»ـ…0-9]/,p=new Set([8234,8237,8294,8206]),g=new Set([8235,8238,8295,8207]),k=new Set([8236,8297,1564]);if(!i)return null;let r=!1;for(let y=0;y<i.length;y++){const F=i[y],I=F.charCodeAt(0);if(F==="{"){r=!0;continue}if(r){F==="}"&&(r=!1);continue}if(p.has(I))return"L";if(g.has(I))return"R";if(!k.has(I)&&!a.test(F)){if(o.test(F)||u.test(F))return"R";if(l.test(F))return"L";if(I>=1424&&I<=2303)return"R";if(I<1424&&I>127)return"L"}}return null}function lt(t){if(!t||typeof t!="string")return!1;const s=t.match(/^(?:\{[^{}]*\})*(.*)/);if(s&&s[1]){const o=s[1];if(o.match(/[!\?\.\u2026\u060C\u061B\u061F]+$/)&&H(o)){const u=t.match(/\{[^{}]*\\[1-4]?c&H[^{}]*\}/g);if(u&&u.length>=3)return!1}}const e=Lt(t);if(!e){if(Et(t))return!0;if(It(t)||Pt(t)||$t(t)&&!Ot(t)&&!Bt(t)||Rt(t)&&At(t)&&H(t)&&Tt(t)==="L")return!1}if(vt(t)&&!e)return!!/[\u202A-\u202E\u200E\u200F\u061C]/.test(t);if(bt(t)&&Nt(t)&&!e||!bt(t)&&_t(t)&&!e)return!1;const i=Tt(t);return i==="L"?!1:i==="R"?!0:e}function wt(t){return Lt(t)}function Yt(t){if(!t||typeof t!="string")return t;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft);let l=o?o[0]:"";if(l&&H(i)){if(l.match(/[.\u2026]{2,}/))return/[.!?؟;:\u061B\u061F\u2026"»”]\s*$/.test(i)?e+st+i:e+l+"‎"+st+i.slice(l.length);if(/["'«»“”„]/.test(l))return e+st+i}return i=i.slice(l.length),i.startsWith(st)?t:e+l+st+i}function Wt(t){if(!t||typeof t!="string")return t;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);if(!H(i)||!/\{[^{}]*\}[^{}]*\{[^{}]*\}/.test(i))return t;const o=[],l=i.match(/^[^\{]+/);if(l){const y=l[0];i=i.slice(y.length),o.push({tag:"",text:y})}const u=/((?:\{[^{}]*\})+)([^\{]*)/g;let a;for(;(a=u.exec(i))!==null;)o.push({tag:a[1],text:a[2]});const p=o[o.length-1];if(!p||!p.text||!/^[!؟؟\.\.\.!،;:…\s]*$/.test(p.text.trim()))return t;const g=p.text.match(/([!؟؟\.\.\.!،;:…\s]+)$/);if(!g)return t;const k=g[1],r=p.text.slice(0,p.text.length-k.length);if(o.length>=3){let y=e;y+=o[0].tag,y+=k,y+=o[1].text.trim(),y+=o[1].tag,y+=" "+o[0].text.trim(),y+=r,y+=o[2].tag;for(let F=3;F<o.length;F++)y+=o[F].tag+o[F].text;return y}return t}function gt(t){t=pt(t);const s=t.split(/(\\[Nn])/);for(let e=0;e<s.length;e+=2){const i=s[e],o=Wt(i);i!==o||o.includes(st)?s[e]=o:s[e]=Yt(o)}return s.join("")}function zt(t){if(!t||typeof t!="string")return t;const s=t.match(/^((?:\{[^{}]*\})*)/),e=s?s[0]:"";let i=t.slice(e.length);const o=i.match(ft),l=o?o[0]:"";if(i=i.slice(l.length),!i.startsWith(st))return t;let u=l;return u.endsWith("‎")&&(u=u.slice(0,-1)),e+u+i.slice(st.length)}function pt(t){if(!t||typeof t!="string")return t;const s=t.split(/(\\[Nn])/);for(let e=0;e<s.length;e+=2)s[e]=zt(s[e]);return s.join("")}function Xt(t){const s=/\{([^{}]+)\}/g,e={fn:new Set,fs:new Set,colors:new Set,other:new Set};let i;for(;(i=s.exec(t))!==null;)i[1].split("\\").forEach(u=>{if(!u)return;const a=u.trim();a.startsWith("fn")?e.fn.add(a.substring(2)):a.startsWith("fs")?e.fs.add(a.substring(2)):/^[1-4]?c&H/.test(a)?e.colors.add("\\"+a):(a.startsWith("an")||a.startsWith("pos")||a.startsWith("move")||a.startsWith("fad"))&&e.other.add("\\"+a)});return e}function xt(t){const s=t.split(",");if(s.length<10)return null;const e=s[0],i=e.includes(":")?e.split(":")[1].trim():e.trim();return{Layer:parseInt(i)||0,Start:s[1].trim(),End:s[2].trim(),Style:s[3].trim(),Name:s[4].trim(),MarginL:s[5].trim(),MarginR:s[6].trim(),MarginV:s[7].trim(),Effect:s[8].trim(),Text:s.slice(9).join(",").trim()}}function kt(t){if(t===0)return"0 Bytes";const s=1024,e=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(s));return Math.round(t/Math.pow(s,i)*100)/100+" "+e[i]}function X(t){if(!t)return 0;const s=t.split(":");if(s.length!==3)return 0;const e=parseInt(s[0],10)||0,i=parseInt(s[1],10)||0,o=s[2].split("."),l=parseInt(o[0],10)||0,u=parseInt((o[1]||"0").padEnd(2,"0").substring(0,2),10);return e*36e5+i*6e4+l*1e3+u*10}function St(t){(isNaN(t)||t<0)&&(t=0);const s=Math.floor(t/36e5);t%=36e5;const e=Math.floor(t/6e4);t%=6e4;const i=Math.floor(t/1e3);t%=1e3;const o=Math.floor(t/10);return`${s}:${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${o.toString().padStart(2,"0")}`}const Ft="https://rtl.codesubs.workers.dev/v1/bg-sync",Vt=Vue.createApp({data(){return{assFile:null,originalFileSnapshot:null,lines:[],editedLineIndices:[],isDragging:!1,fileName:"",fileSize:"0 Bytes",isDarkMode:!1,isProcessing:!1,showDebugModal:!1,debugLineInfo:null,currentIndex:0,rtlPreviewText:"",rtlEditHistory:Object.create(null),rtlEditHistoryLimit:200,errorLog:[],showLinesModalOpen:!1,linesModalType:"all",currentPage:1,pageSize:10,viewMode:"cards",showDummyVideoToggle:!1,dummyVideoUnlockStep:0,dummyVideo:{width:1920,height:1080,color:"#0F2C41",customDuration:null,showOptions:!1,isPlaying:!1,containerWidth:0,containerHeight:0},currentTime:0,playbackInterval:null,resizeObserver:null,useLibassWasm:!0,libassInstance:null,libassReady:!1,libassTrackUpdateTimer:null,libassPartsInstance:null,libassPartsReady:!1,libassPartsTrackUpdateTimer:null,libassPartsFailed:!1,_assMeasureCtx:null,showScriptInfoModal:!1,scriptInfo:[],styles:[],overrideStats:{fn:new Set,fs:new Set,colors:new Set,other:new Set},showFontsModal:!1,jumpToLineNumber:"",deferredPrompt:null,showInstallButton:!1,filterMode:"all",rangeInput:"",isRechecking:!1,mobileMenuOpen:!1,startYear:2026,version:"0.3.5-beta",showDebugButton:!1,showColTime:!1,showColStyle:!1,showColStatus:!1,showColText:!0,showColFontname:!0,showColFontsize:!1,showColPrimaryColour:!1,showColSecondaryColour:!1,showColOutlineColour:!1,showColBackColour:!1,showColBold:!1,showColItalic:!1,showColUnderline:!1,showColStrikeOut:!1,showColScaleX:!1,showColScaleY:!1,showColSpacing:!1,showColAngle:!1,showColBorderStyle:!1,showColOutline:!1,showColShadow:!1,showColAlignment:!1,showColMarginL:!1,showColMarginR:!1,showColMarginV:!1,showColEncoding:!1,showStylesColumnCheckboxes:!1,showBulkConvertModal:!1,showResetConfirmModal:!1,bulkConvertType:"ltr",bulkConvertLinesToConvert:[],bulkConvertProgress:0,bulkConvertTotal:0,bulkConvertSuccess:!1,bulkConvertStartTime:null,bulkConvertEndTime:null,bulkConvertSuccessCount:0,bulkConvertFailureCount:0,_processedFiles:new Set}},computed:{scriptResolution(){const t=this.scriptInfo.find(l=>l.key==="PlayResX"),s=this.scriptInfo.find(l=>l.key==="PlayResY");let e=t?parseInt(t.value,10):0,i=s?parseInt(s.value,10):0;(!Number.isFinite(e)||e<0)&&(e=0),(!Number.isFinite(i)||i<0)&&(i=0);const o=this.viewMode==="dummy-video"&&Number.isFinite(this.dummyVideo.width)&&this.dummyVideo.width>0&&Number.isFinite(this.dummyVideo.height)&&this.dummyVideo.height>0;return e===0&&i===0?o?(e=this.dummyVideo.width,i=this.dummyVideo.height):(e=384,i=288):e===0?o?e=Math.max(1,Math.round(i*(this.dummyVideo.width/this.dummyVideo.height))):e=i===1024?1280:Math.floor(i*4/3):i===0&&(o?i=Math.max(1,Math.round(e*(this.dummyVideo.height/this.dummyVideo.width))):i=e===1280?1024:Math.floor(e*3/4)),{x:e,y:i}},scriptScaleX(){return this.dummyVideo.containerWidth===0?1:this.dummyVideo.containerWidth/this.scriptResolution.x},scriptScaleY(){return this.dummyVideo.containerHeight===0?1:this.dummyVideo.containerHeight/this.scriptResolution.y},fontScaleFactor(){return this.scriptScaleY},fileMaxDuration(){return this.lines.length===0?0:this.lines.reduce((t,s)=>{const e=X(s.End);return Math.max(t,e)},0)},videoDuration(){return this.dummyVideo.customDuration!==null?this.dummyVideo.customDuration:this.lines.length===0?0:this.lines.reduce((t,s)=>{const e=X(s.End);return Math.max(t,e)},0)},formattedDuration(){return St(this.videoDuration)},formattedCurrentTime(){return St(this.currentTime)},libassPartsEnabled(){return!this.useLibassWasm&&!this.libassPartsFailed&&this.viewMode==="dummy-video"&&!!this.assFile&&typeof Ct<"u"},activeSubtitles(){const t=this.lines.filter(s=>{const e=X(s.Start),i=X(s.End);return this.currentTime>=e&&this.currentTime<=i});if(this.currentIndex>=0&&this.currentIndex<this.lines.length){const s=this.lines[this.currentIndex];if(t.includes(s))return[s]}return t},renderedActiveSubtitles(){return this.libassPartsEnabled?[]:(this.activeSubtitles||[]).map((s,e)=>this.renderAssLine(s,e))},currentLine(){return this.lines[this.currentIndex]},totalLines(){return this.lines.length},rtlCount(){return this.lines.filter(t=>t.displaysRTL).length},ltrCount(){return this.lines.filter(t=>!t.displaysRTL).length},showRTLFilter(){return this.rtlCount>0},showLTRFilter(){return this.ltrCount>0},convertibleToRTLCount(){return this.ltrCount},canConvertToRTL(){const t=this.currentLine;return!t||!t.isArabic||t.isRTL?!1:t.displaysRTL===!1},canConvertToLTR(){const t=this.currentLine;if(!t||!t.isRTL)return!1;try{return lt(pt(t.Text))===!1}catch{return!1}},canUndoRtlEdit(){if(!this.currentLine)return!1;const t=this.rtlEditHistory[String(this.currentIndex)];return!!t&&Array.isArray(t.undo)&&t.undo.length>0},canRedoRtlEdit(){if(!this.currentLine)return!1;const t=this.rtlEditHistory[String(this.currentIndex)];return!!t&&Array.isArray(t.redo)&&t.redo.length>0},canResetRtlEdit(){if(!this.currentLine)return!1;const t=this.rtlEditHistory[String(this.currentIndex)];return!t||!t.base||!t.last?!1:!this.isSameRtlSnapshot(this.normalizeRtlSnapshot(t.base),this.normalizeRtlSnapshot(t.last))},hasFileEdits(){return!!this.assFile&&this.editedLineIndices.length>0},canResetToOriginal(){return!!this.assFile&&!!this.originalFileSnapshot&&this.editedLineIndices.length>0},arabicCount(){return this.lines.filter(t=>t.displaysRTL).length},arabicNeedsRtlCount(){return this.lines.filter(t=>t.displaysRTL&&!t.isRTL).length},conversionPercentage(){return this.totalLines===0?0:Math.round(this.rtlCount/this.totalLines*100)},fontCount(){return new Set(this.styles.map(s=>s.Fontname)).size},bulkConvertDuration(){return!this.bulkConvertStartTime||!this.bulkConvertEndTime?0:(this.bulkConvertEndTime-this.bulkConvertStartTime)/1e3},bulkConvertSpeed(){return this.bulkConvertDuration===0||this.bulkConvertTotal===0?0:Math.round(this.bulkConvertTotal/this.bulkConvertDuration)||0},linesModalTitle(){return this.linesModalType==="rtl"?"الأسطر (RTL)":this.linesModalType==="ltr"?"الأسطر (LTR)":"كل الأسطر"},filteredLines(){return this.linesModalType==="rtl"?this.lines.filter(t=>t.displaysRTL):this.linesModalType==="ltr"?this.lines.filter(t=>!t.displaysRTL):this.lines},editorFilteredLines(){return this.filterMode==="rtl"?this.lines.filter(t=>t.displaysRTL):this.filterMode==="ltr"?this.lines.filter(t=>!t.displaysRTL):this.lines},editorFilteredCount(){return this.editorFilteredLines.length},totalPages(){return Math.ceil(this.filteredLines.length/this.pageSize)},paginatedLines(){const t=(this.currentPage-1)*this.pageSize,s=t+this.pageSize;return this.filteredLines.slice(t,s)},isAnyModalOpen(){return this.showLinesModalOpen||this.showScriptInfoModal||this.showFontsModal},canGoToFirstFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){let s=-1,e=1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=X(o.Start);l<e&&(e=l,s=i)}return s===-1?!1:this.currentIndex!==s?!0:Math.abs((this.currentTime||0)-e)>1}for(let s=0;s<this.lines.length;s++){const e=this.lines[s];if(t(e))return this.currentIndex!==s}return!1},canGoToPreviousFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){const s=this.currentTime||0;for(let e=0;e<this.lines.length;e++){const i=this.lines[e];if(!t(i))continue;if(X(i.End)<s)return!0}return!1}for(let s=this.currentIndex-1;s>=0;s--){const e=this.lines[s];if(t(e))return!0}return!1},canGoToNextFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){const s=this.currentTime||0;for(let e=0;e<this.lines.length;e++){const i=this.lines[e];if(!t(i))continue;if(X(i.Start)>s)return!0}return!1}for(let s=this.currentIndex+1;s<this.lines.length;s++){const e=this.lines[s];if(t(e))return!0}return!1},canGoToLastFiltered(){if(this.lines.length===0)return!1;const t=s=>this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL;if(this.viewMode==="dummy-video"){let s=-1,e=-1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=X(o.Start);l>e&&(e=l,s=i)}return s===-1?!1:this.currentIndex!==s?!0:Math.abs((this.currentTime||0)-e)>1}for(let s=this.lines.length-1;s>=0;s--){const e=this.lines[s];if(t(e))return this.currentIndex!==s}return!1},copyrightYear(){const t=new Date().getFullYear();return t===this.startYear?this.startYear:t>this.startYear?`${this.startYear}-${t}`:this.startYear}},watch:{assFile(t){t?this.viewMode==="dummy-video"&&(this.libassPartsFailed=!1,this.setupResizeObserver(),this.initLibassWasm(),this.initLibassWasmParts()):(this.cleanupResizeObserver(),this.disposeLibassWasm(),this.disposeLibassWasmParts())},useLibassWasm(t){t?(this.disposeLibassWasmParts(),this.initLibassWasm(),this.renderLibassWasm()):(this.libassPartsFailed=!1,this.disposeLibassWasm(),this.initLibassWasmParts(),this.renderLibassWasmParts())},viewMode:{handler(t){t==="dummy-video"?(this.libassPartsFailed=!1,this.setupResizeObserver(),this.initLibassWasm(),this.initLibassWasmParts()):(this.cleanupResizeObserver(),this.disposeLibassWasm(),this.disposeLibassWasmParts())},immediate:!0},currentTime(){this.renderLibassWasm(),this.renderLibassWasmParts()},lines:{handler(){this.scheduleLibassTrackUpdate(),this.scheduleLibassPartsTrackUpdate(),this.syncEditedLineIndices()},deep:!0},"dummyVideo.width"(){this.resizeLibassCanvas(),this.resizeLibassPartsCanvas()},"dummyVideo.height"(){this.resizeLibassCanvas(),this.resizeLibassPartsCanvas()},rtlCount(t){t===0&&this.filterMode==="rtl"&&(this.filterMode="all")},ltrCount(t){t===0&&this.filterMode==="ltr"&&(this.filterMode="all")},showColTime(t){if(!t&&!this.showColStyle&&!this.showColStatus&&!this.showColText){this.$nextTick(()=>{this.showColTime=!0});return}this.saveColumnSettings()},showColStyle(t){if(!t&&!this.showColTime&&!this.showColStatus&&!this.showColText){this.$nextTick(()=>{this.showColStyle=!0});return}this.saveColumnSettings()},showColStatus(t){if(!t&&!this.showColTime&&!this.showColStyle&&!this.showColText){this.$nextTick(()=>{this.showColStatus=!0});return}this.saveColumnSettings()},showColText(t){if(!t&&!this.showColTime&&!this.showColStyle&&!this.showColStatus){this.$nextTick(()=>{this.showColText=!0});return}this.saveColumnSettings()},showColFontname(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColFontname=!0});return}this.saveStylesColumnSettings()},showColFontsize(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColFontsize=!0});return}this.saveStylesColumnSettings()},showColPrimaryColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColPrimaryColour=!0});return}this.saveStylesColumnSettings()},showColSecondaryColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColSecondaryColour=!0});return}this.saveStylesColumnSettings()},showColOutlineColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColOutlineColour=!0});return}this.saveStylesColumnSettings()},showColBackColour(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColBackColour=!0});return}this.saveStylesColumnSettings()},showColBold(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColBold=!0});return}this.saveStylesColumnSettings()},showColItalic(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColItalic=!0});return}this.saveStylesColumnSettings()},showColUnderline(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColUnderline=!0});return}this.saveStylesColumnSettings()},showColStrikeOut(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColStrikeOut=!0});return}this.saveStylesColumnSettings()},showColScaleX(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColScaleX=!0});return}this.saveStylesColumnSettings()},showColScaleY(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColScaleY=!0});return}this.saveStylesColumnSettings()},showColSpacing(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColSpacing=!0});return}this.saveStylesColumnSettings()},showColAngle(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColAngle=!0});return}this.saveStylesColumnSettings()},showColBorderStyle(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColBorderStyle=!0});return}this.saveStylesColumnSettings()},showColOutline(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColOutline=!0});return}this.saveStylesColumnSettings()},showColShadow(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColShadow=!0});return}this.saveStylesColumnSettings()},showColAlignment(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColAlignment=!0});return}this.saveStylesColumnSettings()},showColMarginL(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColMarginL=!0});return}this.saveStylesColumnSettings()},showColMarginR(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColMarginR=!0});return}this.saveStylesColumnSettings()},showColMarginV(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColMarginV=!0});return}this.saveStylesColumnSettings()},showColEncoding(t){const s=[this.showColFontname,this.showColFontsize,this.showColPrimaryColour,this.showColSecondaryColour,this.showColOutlineColour,this.showColBackColour,this.showColBold,this.showColItalic,this.showColUnderline,this.showColStrikeOut,this.showColScaleX,this.showColScaleY,this.showColSpacing,this.showColAngle,this.showColBorderStyle,this.showColOutline,this.showColShadow,this.showColAlignment,this.showColMarginL,this.showColMarginR,this.showColMarginV,this.showColEncoding].filter(e=>e).length;if(!t&&s===0){this.$nextTick(()=>{this.showColEncoding=!0});return}this.saveStylesColumnSettings()},currentPage(t){t>this.totalPages&&(this.currentPage=this.totalPages)},linesModalType(){this.currentPage=1},filterMode(){for(let t=0;t<this.lines.length;t++){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}}this.currentIndex=-1,this.updateRTLPreview()},isAnyModalOpen(t){t?document.body.style.overflow="hidden":document.body.style.overflow=""},currentIndex(t){if(this.viewMode==="dummy-video"&&t>=0&&t<this.lines.length){const s=this.lines[t];this.currentTime=X(s.Start)}}},mounted(){this.loadTheme(),this.setupSystemThemeListener(),this.setupPWAInstall(),this._ensureUserIdentity(),this._initCacheStore(),window.addEventListener("online",()=>{this._flushSyncBuffer()});const t=localStorage.getItem("lines-modal-columns");if(t)try{const e=JSON.parse(t);e.showColTime!==void 0&&(this.showColTime=e.showColTime),e.showColStyle!==void 0&&(this.showColStyle=e.showColStyle),e.showColStatus!==void 0&&(this.showColStatus=e.showColStatus),e.showColText!==void 0&&(this.showColText=e.showColText)}catch(e){console.error("Failed to load column settings:",e)}const s=localStorage.getItem("styles-modal-columns");if(s)try{const e=JSON.parse(s);e.showColFontname!==void 0&&(this.showColFontname=e.showColFontname),e.showColFontsize!==void 0&&(this.showColFontsize=e.showColFontsize),e.showColPrimaryColour!==void 0&&(this.showColPrimaryColour=e.showColPrimaryColour),e.showColSecondaryColour!==void 0&&(this.showColSecondaryColour=e.showColSecondaryColour),e.showColOutlineColour!==void 0&&(this.showColOutlineColour=e.showColOutlineColour),e.showColBackColour!==void 0&&(this.showColBackColour=e.showColBackColour),e.showColBold!==void 0&&(this.showColBold=e.showColBold),e.showColItalic!==void 0&&(this.showColItalic=e.showColItalic),e.showColUnderline!==void 0&&(this.showColUnderline=e.showColUnderline),e.showColStrikeOut!==void 0&&(this.showColStrikeOut=e.showColStrikeOut),e.showColScaleX!==void 0&&(this.showColScaleX=e.showColScaleX),e.showColScaleY!==void 0&&(this.showColScaleY=e.showColScaleY),e.showColSpacing!==void 0&&(this.showColSpacing=e.showColSpacing),e.showColAngle!==void 0&&(this.showColAngle=e.showColAngle),e.showColBorderStyle!==void 0&&(this.showColBorderStyle=e.showColBorderStyle),e.showColOutline!==void 0&&(this.showColOutline=e.showColOutline),e.showColShadow!==void 0&&(this.showColShadow=e.showColShadow),e.showColAlignment!==void 0&&(this.showColAlignment=e.showColAlignment),e.showColMarginL!==void 0&&(this.showColMarginL=e.showColMarginL),e.showColMarginR!==void 0&&(this.showColMarginR=e.showColMarginR),e.showColMarginV!==void 0&&(this.showColMarginV=e.showColMarginV),e.showColEncoding!==void 0&&(this.showColEncoding=e.showColEncoding)}catch(e){console.error("Failed to load styles column settings:",e)}},beforeUnmount(){this.cleanupResizeObserver(),this.disposeLibassWasm(),this.disposeLibassWasmParts(),document.body.style.overflow=""},methods:{buildAssForLibass(){let t=`[Script Info]
`;t+=`ScriptType: v4.00+
`,t+=`WrapStyle: 0
`,t+=`ScaledBorderAndShadow: yes
`,t+=`YCbCr Matrix: None
`;const{x:s,y:e}=this.scriptResolution;if(t+=`PlayResX: ${s}
`,t+=`PlayResY: ${e}
`,this.scriptInfo.forEach(i=>{["ScriptType","WrapStyle","ScaledBorderAndShadow","YCbCr Matrix","PlayResX","PlayResY"].includes(i.key)||(t+=`${i.key}: ${i.value}
`)}),t+=`
[V4+ Styles]
`,t+=`Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
`,this.styles.length===0)t+=`Style: Default,Arial,20,&H00FFFFFF,&H000000FF,&H00000000,&H00000000,0,0,0,0,100,100,0,0,1,2,2,2,10,10,10,1
`;else for(const i of this.styles)t+=`Style: ${i.Name},${i.Fontname},${i.Fontsize},${i.PrimaryColour},${i.SecondaryColour},${i.OutlineColour},${i.BackColour},${i.Bold},${i.Italic},${i.Underline},${i.StrikeOut},${i.ScaleX},${i.ScaleY},${i.Spacing},${i.Angle},${i.BorderStyle},${i.Outline},${i.Shadow},${i.Alignment},${i.MarginL},${i.MarginR},${i.MarginV},${i.Encoding}
`;t+=`
[Events]
`,t+=`Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
`;for(const i of this.lines)t+=`Dialogue: ${i.Layer},${i.Start},${i.End},${i.Style},${i.Name},${i.MarginL},${i.MarginR},${i.MarginV},${i.Effect},${i.Text}
`;return t},resizeLibassCanvas(){if(!this.useLibassWasm)return;const t=this.$refs.libassCanvas;if(!t)return;const s=window.devicePixelRatio||1,e=Math.max(1,Math.round((this.dummyVideo.containerWidth||1920)*s)),i=Math.max(1,Math.round((this.dummyVideo.containerHeight||1080)*s));t.width!==e&&(t.width=e),t.height!==i&&(t.height=i),this.libassInstance&&this.libassInstance.resize(e,i)},initLibassWasm(){this.useLibassWasm&&this.assFile&&this.viewMode==="dummy-video"&&(this.libassInstance||this.$nextTick(()=>{if(!this.useLibassWasm||!this.assFile||this.viewMode!=="dummy-video"||this.libassInstance||!this.$refs.libassCanvas)return;if(typeof Ct>"u"){this.useLibassWasm=!1;return}this.libassReady=!1,this.resizeLibassCanvas();const t={canvas:this.$refs.libassCanvas,subContent:this.buildAssForLibass(),workerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker.js",legacyWorkerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker-legacy.js",renderMode:"wasm-blend",fonts:["https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Regular.ttf","https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Bold.ttf"],onReady:()=>{this.libassReady=!0,this.renderLibassWasm()},onError:()=>{this.useLibassWasm=!1,this.disposeLibassWasm()}};try{this.libassInstance=new Ct(t)}catch{this.useLibassWasm=!1,this.disposeLibassWasm()}}))},disposeLibassWasm(){if(this.libassReady=!1,this.libassTrackUpdateTimer&&(clearTimeout(this.libassTrackUpdateTimer),this.libassTrackUpdateTimer=null),this.libassInstance){try{this.libassInstance.dispose()}catch{}this.libassInstance=null}},renderLibassWasm(){this.useLibassWasm&&(!this.libassInstance||!this.libassReady||(this.resizeLibassCanvas(),this.libassInstance.setCurrentTime((this.currentTime||0)/1e3)))},scheduleLibassTrackUpdate(){this.useLibassWasm&&this.libassInstance&&(this.libassTrackUpdateTimer&&clearTimeout(this.libassTrackUpdateTimer),this.libassTrackUpdateTimer=setTimeout(()=>{this.useLibassWasm&&this.libassInstance&&(this.libassInstance.setTrack(this.buildAssForLibass()),this.renderLibassWasm())},250))},resizeLibassPartsCanvas(){if(!this.libassPartsEnabled)return;const t=this.$refs.libassPartsCanvas;if(!t)return;const s=window.devicePixelRatio||1,e=Math.max(1,Math.round((this.dummyVideo.containerWidth||1920)*s)),i=Math.max(1,Math.round((this.dummyVideo.containerHeight||1080)*s));t.width!==e&&(t.width=e),t.height!==i&&(t.height=i),this.libassPartsInstance&&this.libassPartsInstance.resize(e,i)},initLibassWasmParts(){this.libassPartsEnabled&&(this.libassPartsInstance||this.$nextTick(()=>{if(!this.libassPartsEnabled||this.libassPartsInstance||!this.$refs.libassPartsCanvas||typeof Ct>"u")return;this.libassPartsFailed=!1,this.libassPartsReady=!1,this.resizeLibassPartsCanvas();const t={canvas:this.$refs.libassPartsCanvas,subContent:this.buildAssForLibass(),workerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker.js",legacyWorkerUrl:"https://cdn.jsdelivr.net/npm/libass-wasm@4.1.0/dist/js/subtitles-octopus-worker-legacy.js",renderMode:"wasm-blend",fonts:["https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Regular.ttf","https://cdn.jsdelivr.net/npm/tajawal@1.0.0/fonts/Tajawal-Bold.ttf"],onReady:()=>{this.libassPartsReady=!0,this.renderLibassWasmParts()},onError:()=>{this.libassPartsFailed=!0,this.disposeLibassWasmParts()}};try{this.libassPartsInstance=new Ct(t)}catch{this.libassPartsFailed=!0,this.disposeLibassWasmParts()}}))},disposeLibassWasmParts(){if(this.libassPartsReady=!1,this.libassPartsTrackUpdateTimer&&(clearTimeout(this.libassPartsTrackUpdateTimer),this.libassPartsTrackUpdateTimer=null),this.libassPartsInstance){try{this.libassPartsInstance.dispose()}catch{}this.libassPartsInstance=null}},renderLibassWasmParts(){if(this.libassPartsEnabled){if(!this.libassPartsInstance||!this.libassPartsReady){this.initLibassWasmParts();return}this.resizeLibassPartsCanvas(),this.libassPartsInstance.setCurrentTime((this.currentTime||0)/1e3)}},scheduleLibassPartsTrackUpdate(){if(this.libassPartsEnabled){if(!this.libassPartsInstance){this.initLibassWasmParts();return}this.libassPartsTrackUpdateTimer&&clearTimeout(this.libassPartsTrackUpdateTimer),this.libassPartsTrackUpdateTimer=setTimeout(()=>{this.libassPartsEnabled&&this.libassPartsInstance&&(this.libassPartsInstance.setTrack(this.buildAssForLibass()),this.renderLibassWasmParts())},250)}},getFontFamilyStack(t){const s=new Set,e=[],i=o=>{const l=(o||"").trim();if(!l)return;const u=l.toLowerCase();s.has(u)||(s.add(u),e.push(l))};return i(t),i("Tahoma"),i("Arial"),i("Segoe UI"),i("Noto Sans Arabic"),i("Noto Naskh Arabic"),i("Amiri"),i("sans-serif"),e.map(o=>o==="sans-serif"?o:`"${o.replace(/"/g,'\\"')}"`).join(", ")},getLineClipPathId(t){return`ass-clip-${t}`},getLineClipMaskId(t){return`ass-clip-mask-${t}`},renderAssLine(t,s){const e=this.getRenderedParts(t),i=this.getLineStyle(t);if(e.clip&&Number.isFinite(s))if(e.clip.invert){const o=`url(#${this.getLineClipMaskId(s)})`;i.mask=o,i.WebkitMask=o}else{const o=`url(#${this.getLineClipPathId(s)})`;i.clipPath=o,i.WebkitClipPath=o}return{line:t,idx:s,style:i,parts:e.parts,clip:e.clip}},getLineStyle(t){const s={position:"absolute",textAlign:"center",pointerEvents:"none",direction:t.isArabic?"rtl":"ltr"};let e=2;const i=t.Style,o=this.styles.find(g=>g.Name===i);o&&(e=parseInt(o.Alignment));const l=t.Text.match(/\\an([1-9])/);if(l&&(e=parseInt(l[1])),!l){const g=t.Text.match(/\\a(\d+)/);if(g){const k=parseInt(g[1]),r={1:1,2:2,3:3,5:7,6:8,7:9,9:4,10:5,11:6};r[k]&&(e=r[k])}}let u=t.Text.match(/\\pos\s*\(\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*\)/);const a=t.Text.match(/\\move\s*\(\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*(?:,\s*(-?\d+)\s*,\s*(-?\d+)\s*)?\)/);let p=null;if(a){const g=parseFloat(a[1]),k=parseFloat(a[3]),r=parseFloat(a[5]),y=parseFloat(a[7]),F=a[9]?parseInt(a[9]):0,I=a[10]?parseInt(a[10]):0,N=X(t.Start),Q=X(t.End)-N,E=this.currentTime-N,R=F,Y=I>0?I:Q;let A=0;E<=R?A=0:E>=Y?A=1:A=(E-R)/(Y-R);const j=g+(r-g)*A,Z=k+(y-k)*A;p={x:j,y:Z}}else u&&(p={x:parseFloat(u[1]),y:parseFloat(u[3])});if(p){const g=p.x,k=p.y;let r="-50%",y="-50%";[1,4,7].includes(e)&&(r="0%"),[3,6,9].includes(e)&&(r="-100%"),[1,2,3].includes(e)&&(y="-100%"),[7,8,9].includes(e)&&(y="0%");const F=(R,Y,A)=>Math.min(Math.max(R,Y),A);let I=g*this.scriptScaleX,N=k*this.scriptScaleY;const J=Math.floor(this.dummyVideo.containerWidth||0),Q=Math.floor(this.dummyVideo.containerHeight||0);if(J>0&&Q>0){let R=o?parseFloat(o.Fontsize):20;const Y=t.Text.match(/\\fs(\d+(\.\d+)?)/);Y&&(R=parseFloat(Y[1])),(!Number.isFinite(R)||R<=0)&&(R=20);let A=o?parseFloat(o.ScaleX||100)/100:1,j=o?parseFloat(o.ScaleY||100)/100:1;const Z=t.Text.match(/\\fscx(\d+(\.\d+)?)/),V=t.Text.match(/\\fscy(\d+(\.\d+)?)/);Z&&(A=parseFloat(Z[1])/100),V&&(j=parseFloat(V[1])/100),(!Number.isFinite(A)||A<=0)&&(A=1),(!Number.isFinite(j)||j<=0)&&(j=1);const et=R*this.fontScaleFactor*j;let D=(t.Text||"").replace(/\{[^}]*\}/g,"");D=D.replace(/\\h/g," "),D=D.replace(/\\N/g,`
`),D=D.replace(/\\n/g,`
`);const n=D.split(`
`),h=Math.max(1,n.length),c=o?String(o.Bold)==="-1":!1,f=o?String(o.Italic)==="-1":!1,m=o&&o.Fontname||"Arial",C=c?700:400,w=f?"italic":"normal";if(!this._assMeasureCtx){const nt=document.createElement("canvas");this._assMeasureCtx=nt.getContext("2d")}let b=0;if(this._assMeasureCtx){this._assMeasureCtx.font=`${w} ${C} ${Math.max(1,et)}px ${this.getFontFamilyStack(m)}`;for(const nt of n){const ct=this._assMeasureCtx.measureText(nt||"").width||0;ct>b&&(b=ct)}}(!Number.isFinite(b)||b<=0)&&(b=Math.max(1,...n.map(nt=>(nt||"").length))*Math.max(1,et)*.7);const T=b*A,L=h*et*1.35,d=o?parseFloat(o.Outline):2,x=o?parseFloat(o.Shadow):2,P=(Number.isFinite(d)?d:0)*Math.max(this.scriptScaleX,this.scriptScaleY)+(Number.isFinite(x)?x:0)*Math.max(this.scriptScaleX,this.scriptScaleY),v=Math.max(2,Math.round(et*.15)),B=Math.max(1,T+P*2+v*2),$=Math.max(1,L+P*2+v*2),W=r==="0%"?0:r==="-100%"?1:.5,U=y==="0%"?0:y==="-100%"?1:.5,z=Math.max(1,J-v*2),q=Math.max(1,Q-v*2),O=Math.min(1,z/B,q/$),S=B*O,M=$*O,_=v*O,K=W*S+_,tt=J-(1-W)*S-_,it=U*M+_,at=Q-(1-U)*M-_;if(Number.isFinite(K)&&Number.isFinite(tt)&&K<=tt&&(I=F(I,K,tt)),Number.isFinite(it)&&Number.isFinite(at)&&it<=at&&(N=F(N,it,at)),Number.isFinite(K)&&Number.isFinite(tt)&&K>tt&&(I=W===0?_:W===1?J-_:J/2),Number.isFinite(it)&&Number.isFinite(at)&&it>at&&(N=U===0?_:U===1?Q-_:Q/2),O<1){const nt=W===0?"0%":W===1?"100%":"50%",ct=U===0?"0%":U===1?"100%":"50%";s.transformOrigin=`${nt} ${ct}`,s.transform=`translate(${r}, ${y}) scale(${O})`}}s.left=`${I}px`,s.top=`${N}px`,s.width="max-content",s.transform||(s.transform=`translate(${r}, ${y})`),[1,4,7].includes(e)&&(s.textAlign="left"),[3,6,9].includes(e)&&(s.textAlign="right");const E=t.Text.match(/\\org\s*\(\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*\)/);if(E){const R=parseFloat(E[1])*this.scriptScaleX,Y=parseFloat(E[3])*this.scriptScaleY;e===7&&(s.transformOrigin=`${R-I}px ${Y-N}px`)}}else{let g=parseInt(t.MarginL,10)||0,k=parseInt(t.MarginR,10)||0,r=parseInt(t.MarginV,10)||0;o&&(g===0&&(g=parseInt(o.MarginL,10)||0),k===0&&(k=parseInt(o.MarginR,10)||0),r===0&&(r=parseInt(o.MarginV,10)||0)),s.left=`${g*this.scriptScaleX}px`,s.right=`${k*this.scriptScaleX}px`,s.width="auto";const y=(E,R,Y)=>Math.min(Math.max(E,R),Y),F=Math.floor(this.dummyVideo.containerHeight||0),I=Math.floor(this.dummyVideo.containerWidth||0),N=I>0?Math.max(1,I-(g+k)*this.scriptScaleX):0,J=E=>{let R=o?parseFloat(o.Fontsize):20;const Y=E.Text.match(/\\fs(\d+(\.\d+)?)/);Y&&(R=parseFloat(Y[1])),(!Number.isFinite(R)||R<=0)&&(R=20);let A=o?parseFloat(o.ScaleY||100)/100:1;const j=E.Text.match(/\\fscy(\d+(\.\d+)?)/);j&&(A=parseFloat(j[1])/100),(!Number.isFinite(A)||A<=0)&&(A=1);const Z=R*this.fontScaleFactor*A;let V=(E.Text||"").replace(/\{[^}]*\}/g,"");V=V.replace(/\\h/g," "),V=V.replace(/\\N/g,`
`),V=V.replace(/\\n/g,`
`);const et=V.split(`
`),D=Math.max(1,et.length),n=o?String(o.Bold)==="-1":!1,h=o?String(o.Italic)==="-1":!1,c=o&&o.Fontname||"Arial",f=n?700:400,m=h?"italic":"normal";if(!this._assMeasureCtx){const x=document.createElement("canvas");this._assMeasureCtx=x.getContext("2d")}let C=0;if(this._assMeasureCtx){this._assMeasureCtx.font=`${m} ${f} ${Math.max(1,Z)}px ${this.getFontFamilyStack(c)}`;for(const x of et){const P=this._assMeasureCtx.measureText(x||"").width||0;P>C&&(C=P)}}(!Number.isFinite(C)||C<=0)&&(C=Math.max(1,...et.map(x=>(x||"").length))*Math.max(1,Z)*.7);let w=D;N>0&&(w=Math.max(D,Math.ceil(C/N)));const b=o?parseFloat(o.Outline):2,T=o?parseFloat(o.Shadow):2,L=(Number.isFinite(b)?b:0)*Math.max(this.scriptScaleX,this.scriptScaleY)+(Number.isFinite(T)?T:0)*Math.max(this.scriptScaleX,this.scriptScaleY),d=Math.max(1,w*Z*1.35+L*2);return Math.ceil(d)},Q=E=>{const R=this.activeSubtitles||[],Y=R.indexOf(t);if(Y<=0)return 0;let A=0;for(let j=0;j<Y;j++){const Z=R[j];if(!Z||Z===t)continue;const V=Z.Text||"";if(/\\pos\s*\(/.test(V)||/\\move\s*\(/.test(V))continue;let D=2;const n=this.styles.find(f=>f.Name===Z.Style);n&&(D=parseInt(n.Alignment));const h=V.match(/\\an([1-9])/);if(h&&(D=parseInt(h[1])),!h){const f=V.match(/\\a(\d+)/);if(f){const m=parseInt(f[1]),C={1:1,2:2,3:3,5:7,6:8,7:9,9:4,10:5,11:6};C[m]&&(D=C[m])}}(E==="top"?[7,8,9].includes(D):[1,2,3].includes(D))&&(A+=J(Z))}return A};if([7,8,9].includes(e)){const E=r*this.scriptScaleY,R=Q("top");s.top=`${E+R}px`,s.bottom="auto"}else if([4,5,6].includes(e))s.top="50%",s.transform="translateY(-50%)";else{const E=r*this.scriptScaleY,R=Q("bottom"),Y=F>0?y(E+R,0,F):E+R;s.bottom=`${Y}px`,s.top="auto"}[1,4,7].includes(e)&&(s.textAlign="left"),[3,6,9].includes(e)&&(s.textAlign="right")}return s},getRenderedParts(t){if(!t)return{parts:[],clip:null};if(this.libassPartsEnabled)return this.renderLibassWasmParts(),{parts:[],clip:null};const s=[],e=t.Style,i=X(t.Start),l=X(t.End)-i,u=this.currentTime-i,a=this.styles.find(n=>n.Name===e)||{Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF",SecondaryColour:"&H0000FFFF",OutlineColour:"&H00000000",BackColour:"&H00000000",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2"},p=n=>{if(!n)return{r:255,g:255,b:255};let h=n.replace(/&H|&/g,"");if(h.length>=8&&(h=h.substring(2)),h.length>=6){const c=parseInt(h.substring(0,2),16)||0,f=parseInt(h.substring(2,4),16)||0;return{r:parseInt(h.substring(4,6),16)||0,g:f,b:c}}return{r:255,g:255,b:255}},g=n=>{if(!n)return 0;const h=n.replace(/&H|&/g,"");if(h.length>=8){const c=parseInt(h.substring(0,2),16);return isNaN(c)?0:c/255}if(h.length<=2){const c=parseInt(h,16);return isNaN(c)?0:c/255}return 0},k=n=>({fontName:n.Fontname,fontSize:parseFloat(n.Fontsize),c1:p(n.PrimaryColour),a1:g(n.PrimaryColour),c2:p(n.SecondaryColour||"&H0000FFFF"),a2:g(n.SecondaryColour||"&H0000FFFF"),c3:p(n.OutlineColour||"&H00000000"),a3:g(n.OutlineColour||"&H00000000"),c4:p(n.BackColour||"&H00000000"),a4:g(n.BackColour||"&H00000000"),bold:n.Bold==="-1",weight:n.Bold==="-1"?700:400,italic:n.Italic==="-1",underline:n.Underline==="-1",strikeout:n.StrikeOut==="-1",scaleX:parseFloat(n.ScaleX||100)/100,scaleY:parseFloat(n.ScaleY||100)/100,spacing:parseFloat(n.Spacing||0),angleZ:parseFloat(n.Angle||0),angleX:0,angleY:0,skewX:0,skewY:0,outlineX:parseFloat(n.Outline),outlineY:parseFloat(n.Outline),shadowX:parseFloat(n.Shadow),shadowY:parseFloat(n.Shadow),blur:0,borderStyle:parseInt(n.BorderStyle||1),karaokeMode:null,karaokeNextDuration:null,karaokeCursor:0,wrapStyle:0,pMode:0,pbo:0,simpleFade:null,complexFade:null,transforms:[]});let r=k(a),y=null;const F=/({[^}]*})|([^{]+)/g,I=t.Text.match(F)||[],N=n=>Math.max(0,Math.min(1,n)),J=(n,h,c)=>n+(h-n)*c,Q=n=>{const h=[];let c=0;for(;c<n.length;){if(n[c]!=="\\"){c+=1;continue}c+=1;let f="";c<n.length&&/[1-4]/.test(n[c])&&(f=n[c],c+=1);let m="";for(;c<n.length&&/[A-Za-z]/.test(n[c]);)m+=n[c],c+=1;if(!m)continue;const C=`${f}${m}`;let w="";if(c<n.length&&n[c]==="("){const b=c;let T=0;for(;c<n.length;){const L=n[c];if(L==="(")T+=1;else if(L===")"&&(T-=1,T===0)){c+=1;break}c+=1}w=n.slice(b,c).trim()}else{const b=c;for(;c<n.length&&n[c]!=="\\";)c+=1;w=n.slice(b,c).trim()}h.push({tag:C,arg:w})}return h},E=n=>({...n,c1:{...n.c1},c2:{...n.c2},c3:{...n.c3},c4:{...n.c4},simpleFade:n.simpleFade?{...n.simpleFade}:null,complexFade:n.complexFade?{...n.complexFade}:null,transforms:Array.isArray(n.transforms)?n.transforms.slice():[]}),R=n=>({fontSize:n.fontSize,scaleX:n.scaleX,scaleY:n.scaleY,spacing:n.spacing,angleX:n.angleX,angleY:n.angleY,angleZ:n.angleZ,skewX:n.skewX,skewY:n.skewY,outlineX:n.outlineX,outlineY:n.outlineY,shadowX:n.shadowX,shadowY:n.shadowY,blur:n.blur,c1:{...n.c1},c2:{...n.c2},c3:{...n.c3},c4:{...n.c4},a1:n.a1,a2:n.a2,a3:n.a3,a4:n.a4}),Y=(n,h,c,f)=>{switch(h){case"fn":n.fontName=f?a.Fontname:c;break;case"fs":n.fontSize=parseFloat(f?a.Fontsize:c);break;case"fscx":n.scaleX=parseFloat(f?a.ScaleX||100:c)/100;break;case"fscy":n.scaleY=parseFloat(f?a.ScaleY||100:c)/100;break;case"fsp":n.spacing=parseFloat(f?a.Spacing||0:c);break;case"frx":n.angleX=f?0:parseFloat(c);break;case"fry":n.angleY=f?0:parseFloat(c);break;case"frz":case"fr":n.angleZ=parseFloat(f?a.Angle||0:c);break;case"fax":n.skewX=f?0:parseFloat(c);break;case"fay":n.skewY=f?0:parseFloat(c);break;case"c":case"1c":n.c1=p(f?a.PrimaryColour:c);break;case"2c":n.c2=p(f?a.SecondaryColour:c);break;case"3c":n.c3=p(f?a.OutlineColour:c);break;case"4c":n.c4=p(f?a.BackColour:c);break;case"alpha":{const m=f?0:g(c);n.a1=n.a2=n.a3=n.a4=m;break}case"1a":n.a1=g(f?a.PrimaryColour:c);break;case"2a":n.a2=g(f?a.SecondaryColour:c);break;case"3a":n.a3=g(f?a.OutlineColour:c);break;case"4a":n.a4=g(f?a.BackColour:c);break;case"bord":if(f)n.outlineX=n.outlineY=parseFloat(a.Outline);else{const m=parseFloat(c);n.outlineX=n.outlineY=m}break;case"xbord":n.outlineX=parseFloat(f?a.Outline:c);break;case"ybord":n.outlineY=parseFloat(f?a.Outline:c);break;case"shad":if(f)n.shadowX=n.shadowY=parseFloat(a.Shadow);else{const m=parseFloat(c);n.shadowX=n.shadowY=m}break;case"xshad":n.shadowX=parseFloat(f?a.Shadow:c);break;case"yshad":n.shadowY=parseFloat(f?a.Shadow:c);break;case"be":case"blur":n.blur=f?0:parseFloat(c);break;case"b":if(f)n.bold=a.Bold==="-1",n.weight=n.bold?700:400;else{const m=parseInt(c);m===0||m===1?(n.bold=m===1,n.weight=m===1?700:400):(n.weight=m,n.bold=m>=600)}break;case"i":n.italic=f?a.Italic==="-1":c==="1";break;case"u":n.underline=f?a.Underline==="-1":c==="1";break;case"s":n.strikeout=f?a.StrikeOut==="-1":c==="1";break}},A=(n,h)=>{const c=E(n),f=Array.isArray(n.transforms)?n.transforms:[];for(const m of f){const C=Number.isFinite(m.t1)?m.t1:0,w=Number.isFinite(m.t2)?m.t2:l,b=Number.isFinite(m.accel)&&m.accel>0?m.accel:1;let T=0;w<=C?T=h>=w?1:0:T=N((h-C)/(w-C)),b!==1&&(T=N(Math.pow(T,b)));const L=m.from,d=m.to;if(!L||!d)continue;const x=["fontSize","scaleX","scaleY","spacing","angleX","angleY","angleZ","skewX","skewY","outlineX","outlineY","shadowX","shadowY","blur","a1","a2","a3","a4"];for(const v of x)Number.isFinite(L[v])&&Number.isFinite(d[v])&&(c[v]=J(L[v],d[v],T));const P=["c1","c2","c3","c4"];for(const v of P)!L[v]||!d[v]||(c[v]={r:Math.round(J(L[v].r||0,d[v].r||0,T)),g:Math.round(J(L[v].g||0,d[v].g||0,T)),b:Math.round(J(L[v].b||0,d[v].b||0,T))})}return c},j=(n,h)=>{let c=1;if(n.simpleFade&&Number.isFinite(l)&&l>0){const f=Math.max(0,parseInt(n.simpleFade.fadeIn||0,10)||0),m=Math.max(0,parseInt(n.simpleFade.fadeOut||0,10)||0);f>0&&h<f&&(c*=N(h/f)),m>0&&h>l-m&&(c*=N((l-h)/m))}if(n.complexFade){const f=n.complexFade,m=Math.max(0,Math.min(255,parseInt(f.a1,10))),C=Math.max(0,Math.min(255,parseInt(f.a2,10))),w=Math.max(0,Math.min(255,parseInt(f.a3,10))),b=Math.max(0,parseInt(f.t1,10)),T=Math.max(0,parseInt(f.t2,10)),L=Math.max(0,parseInt(f.t3,10)),d=Math.max(0,parseInt(f.t4,10));let x=m;h<b?x=m:h<T?x=T===b?C:J(m,C,N((h-b)/(T-b))):h<L?x=C:h<d?x=d===L?w:J(C,w,N((h-L)/(d-L))):x=w,c*=N(1-x/255)}return N(c)},Z=n=>{if(!n)return null;let h=n.trim();if(h.startsWith("(")&&h.endsWith(")")&&(h=h.slice(1,-1)),h=h.trim(),!h||/[A-Za-z]/.test(h))return null;const c=h.match(/-?\d+/g);if(!c||c.length!==4)return null;const f=c.map(P=>parseInt(P,10));if(f.some(P=>!Number.isFinite(P)))return null;const[m,C,w,b]=f,T=Math.min(m,w)*this.scriptScaleX,L=Math.min(C,b)*this.scriptScaleY,d=Math.abs(w-m)*this.scriptScaleX,x=Math.abs(b-C)*this.scriptScaleY;return!(d>0)||!(x>0)?null:{kind:"rect",x:T,y:L,w:d,h:x}},V=(n,h,c)=>{const f=(n||"").trim();if(!f)return"";const m=Number.isFinite(h)&&h>0?h:1,C=Number.isFinite(c)?c:0,w=f.match(/[A-Za-z]|-?\d+(?:\.\d+)?/g)||[];let b=0,T="",L="",d=0,x=0,P=!1,v=!1,B=null,$=[];const W=O=>typeof O=="string"&&/^[A-Za-z]$/.test(O),U=()=>{for(;b<w.length&&W(w[b]);)return null;if(b>=w.length)return null;const O=parseFloat(w[b]);return b+=1,Number.isFinite(O)?O:null},z=()=>{const O=U(),S=U();return!Number.isFinite(O)||!Number.isFinite(S)?null:{x:O/m*this.scriptScaleX,y:(S+C)/m*this.scriptScaleY}},q=O=>{if(!O)return;$.push(O);const S=$.length;if(S<3)return;const M=$[S-3],_=$[S-2],K=$[S-1];T+=` C ${M.x} ${M.y} ${_.x} ${_.y} ${K.x} ${K.y}`,d=K.x,x=K.y,P=!0};for(;b<w.length;){const O=w[b];if(W(O))L=String(O).toLowerCase(),b+=1;else if(!L){b+=1;continue}if(L==="m"||L==="n"){v=!1,B=null,$=[];const S=z();if(!S)continue;T+=(T?" ":"")+`M ${S.x} ${S.y}`,d=S.x,x=S.y,P=!0;continue}if(L==="l"){for(v=!1,B=null,$=[];b<w.length&&!W(w[b]);){const S=z();if(!S)break;T+=` L ${S.x} ${S.y}`,d=S.x,x=S.y,P=!0}continue}if(L==="b"){for(v=!1,B=null,$=[];b<w.length&&!W(w[b]);){const S=z(),M=z(),_=z();if(!S||!M||!_)break;T+=` C ${S.x} ${S.y} ${M.x} ${M.y} ${_.x} ${_.y}`,d=_.x,x=_.y,P=!0}continue}if(L==="s"){P||(d=0,x=0,P=!0),v=!0,B={x:d,y:x},$=[];const S=[];for(;b<w.length&&!W(w[b]);){const M=z();if(!M)break;S.push(M)}if(S.length>=3){T+=` C ${S[0].x} ${S[0].y} ${S[1].x} ${S[1].y} ${S[2].x} ${S[2].y}`,d=S[2].x,x=S[2].y,P=!0,$=S.slice();for(let M=3;M<S.length;M+=1){const _=S[M-2],K=S[M-1],tt=S[M];T+=` C ${_.x} ${_.y} ${K.x} ${K.y} ${tt.x} ${tt.y}`,d=tt.x,x=tt.y,P=!0}}continue}if(L==="p"){if(!v){const M=z();if(!M)continue;T+=` L ${M.x} ${M.y}`,d=M.x,x=M.y,P=!0;continue}const S=z();if(!S)continue;q(S);continue}if(L==="c"){v&&B&&$.length>=2&&(q({x:B.x,y:B.y}),q({x:$[0].x,y:$[0].y}),q({x:$[1].x,y:$[1].y}),v=!1,B=null,$=[]);continue}}return T.trim()},et=n=>{if(!n)return null;let h=n.trim();if(h.startsWith("(")&&h.endsWith(")")&&(h=h.slice(1,-1)),h=h.trim(),!h)return null;let c=1,f=h;const m=h.indexOf(",");if(m!==-1){const w=h.slice(0,m).trim(),b=h.slice(m+1).trim();if(/^-?\d+(?:\.\d+)?$/.test(w)&&/[A-Za-z]/.test(b)){const T=parseFloat(w);Number.isFinite(T)&&T>0&&(c=T),f=b}}if(!/[A-Za-z]/.test(f))return null;const C=V(f,c,0);return C?{kind:"path",d:C}:null},D=(n,h,c)=>{if(c)return null;const f=Z(h);if(f)return{...f,invert:n==="iclip"};const m=et(h);return m?{...m,invert:n==="iclip"}:null};for(const n of I)if(n.startsWith("{")){const h=n.slice(1,-1),c=Q(h);for(const f of c){const m=f.tag;let C=f.arg?f.arg.trim():"";const w=C==="";switch(m){case"fn":r.fontName=w?a.Fontname:C;break;case"fs":r.fontSize=parseFloat(w?a.Fontsize:C);break;case"fscx":r.scaleX=parseFloat(w?a.ScaleX||100:C)/100;break;case"fscy":r.scaleY=parseFloat(w?a.ScaleY||100:C)/100;break;case"fsp":r.spacing=parseFloat(w?a.Spacing||0:C);break;case"frx":r.angleX=w?0:parseFloat(C);break;case"fry":r.angleY=w?0:parseFloat(C);break;case"frz":case"fr":r.angleZ=parseFloat(w?a.Angle||0:C);break;case"fax":r.skewX=w?0:parseFloat(C);break;case"fay":r.skewY=w?0:parseFloat(C);break;case"c":case"1c":w?r.c1=p(a.PrimaryColour):r.c1=p(C);break;case"2c":w?r.c2=p(a.SecondaryColour):r.c2=p(C);break;case"3c":w?r.c3=p(a.OutlineColour):r.c3=p(C);break;case"4c":w?r.c4=p(a.BackColour):r.c4=p(C);break;case"alpha":const b=w?0:g(C);r.a1=r.a2=r.a3=r.a4=b;break;case"1a":r.a1=g(w?a.PrimaryColour:C);break;case"2a":r.a2=g(w?a.SecondaryColour:C);break;case"3a":r.a3=g(w?a.OutlineColour:C);break;case"4a":r.a4=g(w?a.BackColour:C);break;case"b":if(w)r.bold=a.Bold==="-1",r.weight=r.bold?700:400;else{const d=parseInt(C);d===0||d===1?(r.bold=d===1,r.weight=d===1?700:400):(r.weight=d,r.bold=d>=600)}break;case"i":r.italic=w?a.Italic==="-1":C==="1";break;case"u":r.underline=w?a.Underline==="-1":C==="1";break;case"s":r.strikeout=w?a.StrikeOut==="-1":C==="1";break;case"bord":if(w)r.outlineX=r.outlineY=parseFloat(a.Outline);else{const d=parseFloat(C);r.outlineX=r.outlineY=d}break;case"xbord":r.outlineX=parseFloat(w?a.Outline:C);break;case"ybord":r.outlineY=parseFloat(w?a.Outline:C);break;case"shad":if(w)r.shadowX=r.shadowY=parseFloat(a.Shadow);else{const d=parseFloat(C);r.shadowX=r.shadowY=d}break;case"xshad":r.shadowX=parseFloat(w?a.Shadow:C);break;case"yshad":r.shadowY=parseFloat(w?a.Shadow:C);break;case"be":case"blur":r.blur=w?0:parseFloat(C);break;case"q":r.wrapStyle=w?0:parseInt(C);break;case"p":{if(w){r.pMode=0;break}const d=parseInt(C,10);r.pMode=Number.isFinite(d)?d:0;break}case"pbo":{if(w){r.pbo=0;break}const d=parseFloat(C);r.pbo=Number.isFinite(d)?d:0;break}case"k":case"K":case"kf":case"ko":{if(!w){const d=parseInt(C,10);isNaN(d)||(r.karaokeMode=m,r.karaokeNextDuration=d*10)}break}case"kt":{if(!w){const d=parseInt(C,10);isNaN(d)||(r.karaokeCursor=d*10)}break}case"fad":{if(w){r.simpleFade=null;break}const d=C.match(/\(\s*(\d+)\s*,\s*(\d+)\s*\)/);d&&(r.simpleFade={fadeIn:parseInt(d[1],10),fadeOut:parseInt(d[2],10)});break}case"fade":{if(w){r.complexFade=null;break}const d=C.match(/\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);d&&(r.complexFade={a1:parseInt(d[1],10),a2:parseInt(d[2],10),a3:parseInt(d[3],10),t1:parseInt(d[4],10),t2:parseInt(d[5],10),t3:parseInt(d[6],10),t4:parseInt(d[7],10)});break}case"t":{if(w)break;let d=C;d.startsWith("(")&&d.endsWith(")")&&(d=d.slice(1,-1));const x=d.indexOf("\\");if(x===-1)break;const P=d.slice(0,x).trim().replace(/,+\s*$/,""),v=d.slice(x),B=P?P.split(",").map(M=>M.trim()).filter(Boolean):[];let $=0,W=l,U=1;B.length===1?U=parseFloat(B[0]):B.length===2?($=parseFloat(B[0]),W=parseFloat(B[1])):B.length>=3&&($=parseFloat(B[0]),W=parseFloat(B[1]),U=parseFloat(B[2]));const z=R(r),q=E(r),O=Q(v);for(const M of O)Y(q,M.tag,(M.arg||"").trim(),(M.arg||"").trim()==="");const S=R(q);r.transforms.push({t1:Number.isFinite($)?$:0,t2:Number.isFinite(W)?W:l,accel:Number.isFinite(U)?U:1,from:z,to:S});break}case"clip":case"iclip":{if(w){y=null;break}const d=D(m,C,w);d&&(y=d);break}case"r":const T=C||e,L=this.styles.find(d=>d.Name===T)||a;r=k(L);break}}}else{const h=A(r,u),c=j(h,u);let f="";r.underline&&(f+="underline "),r.strikeout&&(f+="line-through");const m=h.fontSize*this.fontScaleFactor;let C=n;C=C.replace(/\\h/g," "),r.wrapStyle===2?C=C.replace(/\\n/g,`
`):C=C.replace(/\\n/g," ");const w=C.replace(/\\N/g,`
`),b=h.outlineX*this.scriptScaleX,T=h.outlineY*this.scriptScaleY,L=h.shadowX*this.scriptScaleX,d=h.shadowY*this.scriptScaleY,x=h.blur*this.fontScaleFactor,P=h.spacing*this.scriptScaleX,v=(G,ot)=>`rgba(${G.r},${G.g},${G.b},${1-ot})`,B=v(h.c1,h.a1),$=v(h.c2,h.a2),W=v(h.c3,h.a3),U=v(h.c4,h.a4);let z=B,q=b,O=T,S=null;if(r.karaokeNextDuration!==null&&r.karaokeMode){const G=r.karaokeCursor,ot=r.karaokeNextDuration,dt=G+ot,ht=ot>0?(u-G)/ot:1;if(r.karaokeMode==="k"||r.karaokeMode==="ko")z=u<G?$:B,r.karaokeMode==="ko"&&u<G&&(q=0,O=0);else if(r.karaokeMode==="K"||r.karaokeMode==="kf")if(ht<=0)z=$;else if(ht>=1)z=B;else{const yt=Math.max(0,Math.min(1,ht))*100;S=`linear-gradient(90deg, ${B} ${yt}%, ${$} ${yt}%)`,z="transparent"}r.karaokeCursor=dt,r.karaokeNextDuration=null,r.karaokeMode=null}const M=r.borderStyle===3,_=M?void 0:this.generateShadow(q,O,L,d,W,U,x),K=!M&&q===0&&O===0&&x>0,tt=K?"transparent":z;let it=_;if(K){const G=`0 0 ${x}px ${z}`;it=it?`${G}, ${it}`:G}const at=M?Math.max(0,q):0,nt=M?Math.max(0,O):0,ct=M&&(L!==0||d!==0||x>0)?`${L}px ${d}px ${x}px ${U}`:void 0;let rt=[];h.angleX&&rt.push(`rotateX(${h.angleX}deg)`),h.angleY&&rt.push(`rotateY(${h.angleY}deg)`),h.angleZ&&rt.push(`rotateZ(${-h.angleZ}deg)`),(h.scaleX!==1||h.scaleY!==1)&&rt.push(`scale(${h.scaleX}, ${h.scaleY})`),h.skewX&&rt.push(`skewX(${-Math.atan(h.skewX)}rad)`),h.skewY&&rt.push(`skewY(${-Math.atan(h.skewY)}rad)`);const ut=rt.length?rt.join(" "):void 0;if(Number.isFinite(r.pMode)&&r.pMode>0){const G=Math.max(1,Math.floor(r.pMode)),ot=Math.pow(2,G-1),dt=V(n,ot,r.pbo);if(dt){const ht=Math.max(0,(q+O)/2);s.push({kind:"drawing",d:dt,fill:B,stroke:ht>0?W:void 0,strokeWidth:ht>0?ht:void 0,style:{display:"inline-block",overflow:"visible",transform:ut,transformOrigin:ut?"0 0":void 0,opacity:c!==1?c:void 0}})}continue}M?s.push({text:w,style:{fontFamily:this.getFontFamilyStack(r.fontName),fontSize:`${m}px`,lineHeight:1.35,color:tt,fontWeight:r.weight,fontStyle:r.italic?"italic":"normal",textDecoration:f.trim(),whiteSpace:r.wrapStyle===2?"pre":"pre-wrap",letterSpacing:P?`${P}px`:void 0,display:"inline-block",backgroundColor:W,padding:`${nt}px ${at}px`,boxShadow:ct,transform:ut,transformOrigin:ut?"50% 50%":void 0,opacity:c!==1?c:void 0}}):w.split(`
`).forEach((ot,dt)=>{dt>0&&s.push({text:`
`,style:{whiteSpace:r.wrapStyle===2?"pre":"pre-wrap"}}),ot&&s.push({text:ot,style:{fontFamily:this.getFontFamilyStack(r.fontName),fontSize:`${m}px`,lineHeight:1.35,color:tt,fontWeight:r.weight,fontStyle:r.italic?"italic":"normal",textDecoration:f.trim(),textShadow:it,whiteSpace:r.wrapStyle===2?"pre":"pre-wrap",letterSpacing:P?`${P}px`:void 0,transform:ut,display:ut||S?"inline-block":void 0,transformOrigin:"50% 50%",backgroundImage:S||void 0,WebkitBackgroundClip:S?"text":void 0,backgroundClip:S?"text":void 0,WebkitTextFillColor:S?"transparent":void 0,opacity:c!==1?c:void 0}})})}return{parts:s,clip:y}},parseAssColor(t){if(!t)return"white";const s=t.replace(/&H|&/g,"");if(s.length===6){const e=parseInt(s.substring(0,2),16),i=parseInt(s.substring(2,4),16);return`rgb(${parseInt(s.substring(4,6),16)}, ${i}, ${e})`}else if(s.length>=8){const e=parseInt(s.substring(0,2),16),i=parseInt(s.substring(2,4),16),o=parseInt(s.substring(4,6),16),l=parseInt(s.substring(6,8),16),u=1-e/255;return`rgba(${l}, ${o}, ${i}, ${u})`}return"white"},generateShadow(t,s,e,i,o,l,u){let a=[];const p=o||"#000",g=l||"rgba(0,0,0,0.5)",k=u||0;if(t>0||s>0)for(let r=-1;r<=1;r++)for(let y=-1;y<=1;y++)(r!==0||y!==0)&&a.push(`${r*t}px ${y*s}px ${k}px ${p}`);return(e!==0||i!==0)&&a.push(`${e}px ${i}px ${k}px ${g}`),a.join(", ")},formatTime(t){return St(t)},parseTime(t){return X(t)},openDummyVideoOptions(){this.dummyVideo.showOptions=!0},toggleViewMode(t){this.viewMode=t},togglePlayback(){this.dummyVideo.isPlaying?this.pauseVideo():this.playVideo()},playVideo(){this.dummyVideo.isPlaying=!0,this.playbackInterval&&clearInterval(this.playbackInterval);let t=performance.now();this.playbackInterval=setInterval(()=>{const s=performance.now(),e=s-t;t=s,this.currentTime+=e;const i=this.videoDuration||0;i>0&&this.currentTime>=i&&(this.currentTime=this.currentTime%i)},16)},pauseVideo(){this.dummyVideo.isPlaying=!1,this.playbackInterval&&(clearInterval(this.playbackInterval),this.playbackInterval=null)},seek(t){this.currentTime=parseInt(t)},saveDummyOptions(){this.dummyVideo.showOptions=!1,this.resizeLibassCanvas(),this.renderLibassWasm()},saveColumnSettings(){const t={showColTime:this.showColTime,showColStyle:this.showColStyle,showColStatus:this.showColStatus,showColText:this.showColText};localStorage.setItem("lines-modal-columns",JSON.stringify(t))},saveStylesColumnSettings(){const t={showColFontname:this.showColFontname,showColFontsize:this.showColFontsize,showColPrimaryColour:this.showColPrimaryColour,showColSecondaryColour:this.showColSecondaryColour,showColOutlineColour:this.showColOutlineColour,showColBackColour:this.showColBackColour,showColBold:this.showColBold,showColItalic:this.showColItalic,showColUnderline:this.showColUnderline,showColStrikeOut:this.showColStrikeOut,showColScaleX:this.showColScaleX,showColScaleY:this.showColScaleY,showColSpacing:this.showColSpacing,showColAngle:this.showColAngle,showColBorderStyle:this.showColBorderStyle,showColOutline:this.showColOutline,showColShadow:this.showColShadow,showColAlignment:this.showColAlignment,showColMarginL:this.showColMarginL,showColMarginR:this.showColMarginR,showColMarginV:this.showColMarginV,showColEncoding:this.showColEncoding};localStorage.setItem("styles-modal-columns",JSON.stringify(t))},recheckAllLines(){this.isRechecking=!0,this.lines.forEach(t=>{t.isRTL=wt(t.Text),t.displaysRTL=lt(t.Text),t.isArabic=H(t.Text),t.hasBidiNeutral=mt(t.Text)}),this.isRechecking=!1},handleRangeInput(){const t=this.rangeInput.trim();if(!t)return;if(/^\d+$/.test(t)){const e=parseInt(t);e>=1&&e<=this.totalLines&&(this.goToLine(e-1),this.rangeInput="");return}const s=t.match(/^(\d+)-(\d+)$/);if(s){const e=parseInt(s[1]);e>=1&&e<=this.totalLines&&(this.goToLine(e-1),this.rangeInput="")}},logError(t){const s=new Date().toLocaleTimeString();this.errorLog.push(`[${s}] ${t}`),console.error(t)},clearErrorLog(){this.errorLog=[]},async loadTheme(){const t=localStorage.getItem("rtl-editor-theme");t?this.isDarkMode=t==="dark":this.isDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches,this.applyTheme()},saveTheme(){localStorage.setItem("rtl-editor-theme",this.isDarkMode?"dark":"light")},toggleTheme(){this.isDarkMode=!this.isDarkMode,this.applyTheme(),this.saveTheme()},applyTheme(){this.isDarkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")},setupSystemThemeListener(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",s=>{localStorage.getItem("rtl-editor-theme")||(this.isDarkMode=s.matches,this.applyTheme())})},setupPWAInstall(){window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),this.deferredPrompt=t,this.showInstallButton=!0}),window.addEventListener("appinstalled",()=>{this.deferredPrompt=null,this.showInstallButton=!1})},async installPWA(){if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome:t}=await this.deferredPrompt.userChoice;t==="accepted"&&(this.deferredPrompt=null,this.showInstallButton=!1)}},handleDrop(t){this.isDragging=!1;const s=t.dataTransfer.files[0];s&&s.name.endsWith(".ass")&&(this.initiateBackgroundSync(s),this.parseFile(s))},handleFileUpload(t){const s=t.target.files[0];s&&s.name.endsWith(".ass")&&(this.initiateBackgroundSync(s),this.parseFile(s))},async _initCacheStore(){try{const t=indexedDB.open("AppSysCache",2);t.onupgradeneeded=s=>{const e=s.target.result;e.objectStoreNames.contains("app_state_buffer")||e.createObjectStore("app_state_buffer",{keyPath:"id",autoIncrement:!0}),e.objectStoreNames.contains("user_identity_store")||e.createObjectStore("user_identity_store",{keyPath:"key"})},t.onsuccess=s=>{this._sysDB=s.target.result,this._flushSyncBuffer(),this._ensureUserIdentity()}}catch{}},_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=Math.random()*16|0,e=t=="x"?s:s&3|8;return e.toString(16)})},async _ensureUserIdentity(){const t="app_usr_meta_v1",s="usr_id_meta";let e=null;const i=localStorage.getItem(t);if(i)try{e=JSON.parse(atob(i))}catch{}if(!e&&this._sysDB)try{const u=this._sysDB.transaction(["user_identity_store"],"readonly").objectStore("user_identity_store").get(s);await new Promise(a=>{u.onsuccess=()=>{u.result&&(e=u.result.data),a()},u.onerror=()=>a()})}catch{}e||(e={uid:this._generateUUID(),created:Date.now(),uploads:0,edits:0,last_active:Date.now()}),this._userStats=e,this._saveUserStats();try{const o=this._userStats&&this._userStats.uid?String(this._userStats.uid).replace(/-/g,"_"):null;o&&window.LogRocket&&typeof window.LogRocket.identify=="function"&&window.LogRocket.identify(o)}catch{}},async _saveUserStats(){if(!this._userStats)return;const t="app_usr_meta_v1",s="usr_id_meta";this._userStats.last_active=Date.now();try{localStorage.setItem(t,btoa(JSON.stringify(this._userStats)))}catch{}if(this._sysDB)try{this._sysDB.transaction(["user_identity_store"],"readwrite").objectStore("user_identity_store").put({key:s,data:this._userStats})}catch{}},_incrementStats(t){this._userStats&&(t==="upload"&&this._userStats.uploads++,t==="edit"&&this._userStats.edits++,this._saveUserStats())},async _extractFileStats(t){return new Promise(s=>{const e=new FileReader;e.onload=i=>{const l=i.target.result.split(/\r?\n/);let u=0,a=0,p=0;const g=new Set;let k=1;for(const r of l){const y=r.trim();if(y.startsWith("Format:")){if(y.includes("Fontname")){const I=y.substring(7).split(",").map(N=>N.trim()).indexOf("Fontname");I!==-1&&(k=I)}}else if(y.startsWith("Style:")){const F=y.substring(6).split(",");if(F.length>k){const I=F[k].trim();g.add(I)}}else if(y.startsWith("Dialogue:")){u++;const F=y.substring(9).trim(),I=xt(F);I&&(lt(I.Text)?a++:p++)}}s({totalLines:u,rtlCount:a,ltrCount:p,fontCount:g.size,fileSize:kt(t.size)})},e.onerror=()=>s(null),e.readAsText(t)})},async _isDuplicate(t){const s=`${t.name}_${t.size}_${t.lastModified}`;return this._processedFiles.has(s)?!0:this._sysDB?new Promise(e=>{try{const l=this._sysDB.transaction(["app_state_buffer"],"readonly").objectStore("app_state_buffer").getAll();l.onsuccess=()=>{const a=l.result.some(p=>p.file.name===t.name&&p.file.size===t.size&&p.file.lastModified===t.lastModified);e(a)},l.onerror=()=>e(!1)}catch{e(!1)}}):!1},async _bufferData(t){if(!(!this._sysDB||await this._isDuplicate(t)))try{this._sysDB.transaction(["app_state_buffer"],"readwrite").objectStore("app_state_buffer").add({file:t,timestamp:Date.now(),status:"pending"})}catch{}},async _flushSyncBuffer(){if(!(!this._sysDB||!navigator.onLine||this._isSyncing)){this._isSyncing=!0;try{const e=this._sysDB.transaction(["app_state_buffer"],"readonly").objectStore("app_state_buffer").getAll();e.onsuccess=async()=>{const i=e.result;if(!i||i.length===0){this._isSyncing=!1;return}this._userStats||await this._ensureUserIdentity(),i.sort((o,l)=>o.timestamp-l.timestamp);for(const o of i){if(!navigator.onLine)break;await new Promise(l=>setTimeout(l,3e3));try{const l=new FormData;l.append("document",o.file);const u=await this._extractFileStats(o.file);if(u&&l.append("X-File-Stats",JSON.stringify(u)),this._userStats&&(this._incrementStats("upload"),l.append("X-User-Data",btoa(JSON.stringify(this._userStats)))),(await fetch(Ft,{method:"POST",body:l})).ok){const p=`${o.file.name}_${o.file.size}_${o.file.lastModified}`;this._processedFiles.add(p),this._sysDB.transaction(["app_state_buffer"],"readwrite").objectStore("app_state_buffer").delete(o.id)}}catch{}}this._isSyncing=!1}}catch{this._isSyncing=!1}}},async initiateBackgroundSync(t){if(!t||!t.name.endsWith(".ass")||(this._userStats||await this._ensureUserIdentity(),await this._isDuplicate(t)))return;if(!navigator.onLine){this._bufferData(t);return}const e=`${t.name}_${t.size}_${t.lastModified}`;this._processedFiles.add(e);const i=new FormData;i.append("document",t);const o=await this._extractFileStats(t);o&&i.append("X-File-Stats",JSON.stringify(o)),this._userStats&&(this._incrementStats("upload"),i.append("X-User-Data",btoa(JSON.stringify(this._userStats))));try{fetch(Ft,{method:"POST",body:i}).then(l=>{l.ok||(this._processedFiles.delete(e),this._bufferData(t))}).catch(()=>{this._processedFiles.delete(e),this._bufferData(t)})}catch{this._processedFiles.delete(e),this._bufferData(t)}},async parseFile(t){try{this.showResetConfirmModal=!1,this.fileName=t.name,this.fileSize=kt(t.size);const s=await t.text(),e=s.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`);let i=!1,o=!1,l=!1,u=-1;this.lines=[],this.scriptInfo=[],this.styles=[],this.overrideStats={fn:new Set,fs:new Set,colors:new Set,other:new Set};for(let p=0;p<e.length;p++){const g=e[p],k=g.trim();if(k==="[Script Info]"){o=!0,i=!1,l=!1;continue}if(k==="[V4+ Styles]"){l=!0,o=!1,i=!1;continue}if(k==="[Events]"){i=!0,o=!1,l=!1,u=p;continue}if(k.startsWith("[")&&k!=="[Events]"){o=!1,i=!1,l=!1;continue}if(o&&k.includes(":")){const r=k.split(":");if(r.length>=2){const y=r[0].trim(),F=r.slice(1).join(":").trim();this.scriptInfo.push({key:y,value:F})}}if(l&&k.startsWith("Style:")){const r=k.substring(6).split(",");r.length>=2&&this.styles.push({Name:r[0].trim(),Fontname:r[1].trim(),Fontsize:r[2].trim(),PrimaryColour:r[3].trim(),SecondaryColour:r[4].trim(),OutlineColour:r[5].trim(),BackColour:r[6].trim(),Bold:r[7].trim(),Italic:r[8].trim(),Underline:r[9].trim(),StrikeOut:r[10].trim(),ScaleX:r[11].trim(),ScaleY:r[12].trim(),Spacing:r[13].trim(),Angle:r[14].trim(),BorderStyle:r[15].trim(),Outline:r[16].trim(),Shadow:r[17].trim(),Alignment:r[18].trim(),MarginL:r[19].trim(),MarginR:r[20].trim(),MarginV:r[21].trim(),Encoding:r[22].trim()})}if(i&&k.startsWith("Dialogue:"))try{const r=xt(g);if(r){r.isRTL=wt(r.Text),r.displaysRTL=lt(r.Text);const y=Xt(r.Text);y.fn.forEach(F=>this.overrideStats.fn.add(F)),y.fs.forEach(F=>this.overrideStats.fs.add(F)),y.colors.forEach(F=>this.overrideStats.colors.add(F)),y.other.forEach(F=>this.overrideStats.other.add(F)),r.isArabic=H(r.Text),r.hasBidiNeutral=mt(r.Text),r.originalIndex=this.lines.length,this.lines.push(r)}}catch(r){this.logError(`Failed to parse line ${p+1}: ${r.message}`)}}let a="";u>0?a=e.slice(0,u+1).join(`
`)+`
`:a=s.split("[Events]")[0]+`[Events]
`,this.assFile={header:a,lines:e},this.currentIndex=0,this.updateRTLPreview(),this.originalFileSnapshot=this.createFileSnapshot(),this.syncEditedLineIndices(),this.lines.length===0&&this.logError("No dialogue lines found in the file")}catch(s){this.logError(`Failed to parse file: ${s.message}`)}},updateRTLPreview(){this.currentLine?(this.rtlPreviewText=gt(this.currentLine.Text),this.ensureRtlHistorySynced(this.currentIndex)):this.rtlPreviewText=""},createFileSnapshot(){return{header:this.assFile?this.assFile.header:"",assFileLines:this.assFile?this.assFile.lines:[],lines:this.lines.map(t=>({...t})),scriptInfo:this.scriptInfo.map(t=>({...t})),styles:this.styles.map(t=>({...t})),fileName:this.fileName,fileSize:this.fileSize,overrideStats:{fn:[...this.overrideStats.fn],fs:[...this.overrideStats.fs],colors:[...this.overrideStats.colors],other:[...this.overrideStats.other]}}},syncEditedLineIndices(){if(!this.originalFileSnapshot||!Array.isArray(this.originalFileSnapshot.lines)){this.editedLineIndices=[];return}const t=this.originalFileSnapshot.lines,s=[],e=Math.max(this.lines.length,t.length);for(let i=0;i<e;i++){const o=this.lines[i],l=t[i],u=o?String(o.Text??""):"",a=l?String(l.Text??""):"";(!o||!l||u!==a)&&s.push(i)}this.editedLineIndices=s},restoreFileSnapshot(t){t&&(this.assFile={header:t.header||"",lines:t.assFileLines||[]},this.lines=Array.isArray(t.lines)?t.lines.map(s=>({...s})):[],this.scriptInfo=Array.isArray(t.scriptInfo)?t.scriptInfo.map(s=>({...s})):[],this.styles=Array.isArray(t.styles)?t.styles.map(s=>({...s})):[],this.fileName=t.fileName||"",this.fileSize=t.fileSize||"0 Bytes",this.overrideStats={fn:new Set(t.overrideStats?.fn||[]),fs:new Set(t.overrideStats?.fs||[]),colors:new Set(t.overrideStats?.colors||[]),other:new Set(t.overrideStats?.other||[])},this.currentIndex=0,this.rtlPreviewText="",this.rtlEditHistory=Object.create(null),this.updateRTLPreview(),this.syncEditedLineIndices())},resetToOriginalFile(){this.restoreFileSnapshot(this.originalFileSnapshot)},openResetToOriginalConfirm(){this.canResetToOriginal&&(this.showResetConfirmModal=!0)},confirmResetToOriginal(){this.showResetConfirmModal=!1,this.resetToOriginalFile()},cancelResetToOriginal(){this.showResetConfirmModal=!1},createRtlSnapshot(t,s){return{lineText:String(t??""),previewText:String(s??"")}},isSameRtlSnapshot(t,s){return!!t&&!!s&&t.lineText===s.lineText&&t.previewText===s.previewText},normalizeRtlSnapshot(t){return t&&typeof t=="object"?this.createRtlSnapshot(t.lineText,t.previewText):this.createRtlSnapshot(t,t)},getRtlHistory(t,s=null){const e=String(t);if(!this.rtlEditHistory[e]){const o=s?this.normalizeRtlSnapshot(s):this.createRtlSnapshot("","");this.rtlEditHistory[e]={undo:[],redo:[],base:o,last:o}}const i=this.rtlEditHistory[e];return Array.isArray(i.undo)||(i.undo=[]),Array.isArray(i.redo)||(i.redo=[]),i.base||(i.base=i.last),i.base=this.normalizeRtlSnapshot(i.base),i.last=this.normalizeRtlSnapshot(i.last),i.undo=i.undo.map(o=>this.normalizeRtlSnapshot(o)),i.redo=i.redo.map(o=>this.normalizeRtlSnapshot(o)),i},ensureRtlHistorySynced(t){if(!this.currentLine)return null;const s=this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText),e=this.getRtlHistory(t,s);return!this.isSameRtlSnapshot(e.last,s)&&e.undo.length===0&&e.redo.length===0&&(e.last=s),e},resetRtlHistory(t,s=""){const e=String(t),i=this.normalizeRtlSnapshot(s);this.rtlEditHistory[e]={undo:[],redo:[],base:i,last:i}},applyRtlStateToCurrentLine(t){if(!this.currentLine)return;const s=this.normalizeRtlSnapshot(t);this.rtlPreviewText=s.previewText,this.currentLine.Text=s.lineText,this.currentLine.isRTL=wt(this.currentLine.Text),this.currentLine.displaysRTL=lt(this.currentLine.Text),this.currentLine.isArabic=H(this.currentLine.Text),this.currentLine.hasBidiNeutral=mt(this.currentLine.Text)},undoRtlEdit(){if(!this.currentLine)return;const t=this.ensureRtlHistorySynced(this.currentIndex);if(!t||t.undo.length===0)return;const s=t.undo.pop();t.redo.push(t.last),t.last=s,this.applyRtlStateToCurrentLine(s)},redoRtlEdit(){if(!this.currentLine)return;const t=this.ensureRtlHistorySynced(this.currentIndex);if(!t||t.redo.length===0)return;const s=t.redo.pop();t.undo.push(t.last),t.undo.length>this.rtlEditHistoryLimit&&t.undo.splice(0,t.undo.length-this.rtlEditHistoryLimit),t.last=s,this.applyRtlStateToCurrentLine(s)},resetRtlEditToBase(){if(!this.currentLine)return;const t=this.ensureRtlHistorySynced(this.currentIndex)||this.getRtlHistory(this.currentIndex);if(!t||!t.base)return;const s=this.normalizeRtlSnapshot(t.base);t.undo=[],t.redo=[],t.last=s,this.applyRtlStateToCurrentLine(s)},handleDummyVideoUnlockFirstStep(){this.showDummyVideoToggle||(this.dummyVideoUnlockStep=1)},handleDummyVideoUnlockSecondStep(){this.showDummyVideoToggle||this.dummyVideoUnlockStep===1&&(this.showDummyVideoToggle=!0,this.dummyVideoUnlockStep=0)},applyRTLConversion(){if(this.currentLine)try{const t=this.ensureRtlHistorySynced(this.currentIndex),s=t?t.last:this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText),e=this.createRtlSnapshot(this.rtlPreviewText,this.rtlPreviewText);t&&!this.isSameRtlSnapshot(s,e)&&(t.undo.push(s),t.undo.length>this.rtlEditHistoryLimit&&t.undo.splice(0,t.undo.length-this.rtlEditHistoryLimit),t.redo=[],t.last=e),this.applyRtlStateToCurrentLine(e)}catch(t){this.logError(`Failed to apply RTL conversion: ${t.message}`)}},convertRTLtoLTR(){if(this.currentLine&&this.currentLine.isRTL)try{const t=this.ensureRtlHistorySynced(this.currentIndex),s=t?t.last:this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText);this.currentLine.Text=pt(this.currentLine.Text),this.currentLine.isRTL=!1,this.currentLine.displaysRTL=lt(this.currentLine.Text),this.currentLine.isArabic=H(this.currentLine.Text),this.currentLine.hasBidiNeutral=mt(this.currentLine.Text),this.rtlPreviewText=gt(this.currentLine.Text);const e=this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText);t&&!this.isSameRtlSnapshot(s,e)&&(t.undo.push(s),t.undo.length>this.rtlEditHistoryLimit&&t.undo.splice(0,t.undo.length-this.rtlEditHistoryLimit),t.redo=[],t.last=e)}catch(t){this.logError(`Failed to convert RTL to LTR: ${t.message}`)}},convertFilteredToLTR(){const t=this.filteredLines.filter(s=>s.isRTL);this.bulkConvertLinesToConvert=t,this.bulkConvertType="ltr",this.bulkConvertProgress=0,this.bulkConvertTotal=t.length,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0,this.showBulkConvertModal=!0},convertFilteredToRTL(){const t=this.filteredLines.filter(s=>s.displaysRTL&&!s.isRTL);this.bulkConvertLinesToConvert=t,this.bulkConvertType="rtl",this.bulkConvertProgress=0,this.bulkConvertTotal=t.length,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0,this.showBulkConvertModal=!0},async performBulkConversion(){this.bulkConvertStartTime=Date.now(),this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0;const t=5;let s=0;const e=()=>new Promise(i=>{setTimeout(()=>{const o=Math.min(s+t,this.bulkConvertLinesToConvert.length);for(let l=s;l<o;l++){const u=this.bulkConvertLinesToConvert[l];try{this.bulkConvertType==="ltr"?(u.Text=pt(u.Text),u.isRTL=!1,u.displaysRTL=lt(u.Text),u.isArabic=H(u.Text)):(u.Text=gt(u.Text),u.isRTL=!0,u.displaysRTL=lt(u.Text),u.isArabic=H(u.Text)),this.bulkConvertSuccessCount++}catch(a){this.bulkConvertFailureCount++,this.logError(`Failed to convert line ${u.originalIndex+1}: ${a.message}`)}}s=o,this.bulkConvertProgress=s,s<this.bulkConvertLinesToConvert.length?e().then(i):(this.bulkConvertEndTime=Date.now(),this.bulkConvertSuccess=!0,i())},0)});await e(),this.updateRTLPreview(),this.currentLine&&this.resetRtlHistory(this.currentIndex,this.rtlPreviewText)},cancelBulkConversion(){this.showBulkConvertModal=!1,this.bulkConvertProgress=0,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0},closeBulkConvertModal(){this.showBulkConvertModal=!1,this.bulkConvertProgress=0,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0},handleRTLTextEdit(t){if(this.currentLine)try{const s=t&&t.target?String(t.target.value??""):this.rtlPreviewText;s!==this.rtlPreviewText&&(this.rtlPreviewText=s);const e=this.getRtlHistory(this.currentIndex,this.createRtlSnapshot(this.currentLine.Text,this.rtlPreviewText)),i=this.createRtlSnapshot(s,s),o=e.last;this.isSameRtlSnapshot(i,o)||(e.undo.push(o),e.undo.length>this.rtlEditHistoryLimit&&e.undo.splice(0,e.undo.length-this.rtlEditHistoryLimit),e.redo=[],e.last=i),this.applyRtlStateToCurrentLine(i)}catch(s){this.logError(`Failed to update text: ${s.message}`)}},goToLine(t){if(t>=0&&t<this.lines.length){const s=this.lines[t];this.filterMode!=="all"&&(this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL||(this.filterMode="all")),this.currentIndex=t,this.updateRTLPreview(),this.showLinesModalOpen=!1}},showLinesModal(t){this.linesModalType=t,this.currentPage=1,this.showLinesModalOpen=!0},goToFirstPage(){this.currentPage=1},goToLastPage(){this.currentPage=this.totalPages},openFontsModal(){this.showFontsModal=!0},openDebugModal(){this.showDebugModal=!0,this.updateDebugInfo()},updateDebugInfo(){if(!this.currentLine)return;const t=this.currentLine.Text;this.debugLineInfo={text:t,length:t.length,hasRLE:t.includes(st),isRTL:wt(t),isArabic:H(t),startRegex:/^((?:\{[^{}]*\})*)\u202B/.test(t),newlineRegex:/(\\[Nn])((?:\{[^{}]*\})*)\u202B/.test(t),charCodes:t.split("").map(s=>"\\u"+s.charCodeAt(0).toString(16).padStart(4,"0")).join(" ")}},runDiagnostics(){let t=0,s=0,e=[],i=0,o=0;this.lines.forEach((u,a)=>{const p=wt(u.Text),g=u.Text.includes(st);g&&i++,p&&o++,u.isRTL!==p&&(e.push(`Line ${a+1}: Stored isRTL=${u.isRTL}, Calc=${p}, HasRLE=${g}`),u.isRTL?t++:s++)});const l=`Diagnostics Complete:
RLE Constant Check: OK
Total Lines: ${this.lines.length}
Lines with RLE char (Strict Check): ${i}
Lines detected as RTL (Calc): ${o}
False Positives (Stored=True, Calc=False): ${t}
False Negatives (Stored=False, Calc=True): ${s}

Details (First 10):
${e.slice(0,10).join(`
`)}`;alert(l),console.log(l)},jumpToLine(){const t=parseInt(this.jumpToLineNumber);!isNaN(t)&&t>=1&&t<=this.lines.length&&(this.goToLine(t-1),this.jumpToLineNumber="")},goToFirstLine(){if(this.viewMode==="dummy-video"){const t=i=>this.filterMode==="all"||this.filterMode==="rtl"&&i.displaysRTL||this.filterMode==="needsrtl"&&i.isArabic&&!i.isRTL||this.filterMode==="ltr"&&!i.displaysRTL;let s=-1,e=1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=X(o.Start);l<e&&(e=l,s=i)}s!==-1&&(this.currentIndex=s,this.currentTime=e,this.updateRTLPreview());return}this.currentIndex=-1,this.goToNextLine(),this.currentIndex===-1&&this.updateRTLPreview()},goToPreviousLine(){if(this.viewMode==="dummy-video"){const s=l=>this.filterMode==="all"||this.filterMode==="rtl"&&l.displaysRTL||this.filterMode==="needsrtl"&&l.isArabic&&!l.isRTL||this.filterMode==="ltr"&&!l.displaysRTL,e=this.currentTime||0;let i=-1,o=-1/0;for(let l=0;l<this.lines.length;l++){const u=this.lines[l];if(!s(u))continue;const a=X(u.End);a<e&&a>o&&(o=a,i=l)}i!==-1&&(this.currentIndex=i,this.currentTime=X(this.lines[i].Start),this.updateRTLPreview());return}let t=this.currentIndex-1;for(;t>=0;){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}t--}},goToNextLine(){if(this.viewMode==="dummy-video"){const s=l=>this.filterMode==="all"||this.filterMode==="rtl"&&l.displaysRTL||this.filterMode==="needsrtl"&&l.isArabic&&!l.isRTL||this.filterMode==="ltr"&&!l.displaysRTL,e=this.currentTime||0;let i=-1,o=1/0;for(let l=0;l<this.lines.length;l++){const u=this.lines[l];if(!s(u))continue;const a=X(u.Start);a>e&&a<o&&(o=a,i=l)}i!==-1&&(this.currentIndex=i,this.currentTime=o,this.updateRTLPreview());return}let t=this.currentIndex+1;for(;t<this.lines.length;){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}t++}},goToLastLine(){if(this.viewMode==="dummy-video"){const t=i=>this.filterMode==="all"||this.filterMode==="rtl"&&i.displaysRTL||this.filterMode==="needsrtl"&&i.isArabic&&!i.isRTL||this.filterMode==="ltr"&&!i.displaysRTL;let s=-1,e=-1/0;for(let i=0;i<this.lines.length;i++){const o=this.lines[i];if(!t(o))continue;const l=X(o.Start);l>e&&(e=l,s=i)}s!==-1&&(this.currentIndex=s,this.currentTime=e,this.updateRTLPreview());return}for(let t=this.lines.length-1;t>=0;t--){const s=this.lines[t];if(this.filterMode==="all"||this.filterMode==="rtl"&&s.displaysRTL||this.filterMode==="needsrtl"&&s.isArabic&&!s.isRTL||this.filterMode==="ltr"&&!s.displaysRTL){this.currentIndex=t,this.updateRTLPreview();return}}this.currentIndex=-1,this.updateRTLPreview()},bulkConvertToRTL(){const t=this.lines.filter(s=>!s.displaysRTL);t.length!==0&&(this.bulkConvertLinesToConvert=t,this.bulkConvertType="rtl",this.bulkConvertProgress=0,this.bulkConvertTotal=t.length,this.bulkConvertSuccess=!1,this.bulkConvertSuccessCount=0,this.bulkConvertFailureCount=0,this.showBulkConvertModal=!0)},exportAssFile(){try{let t=this.assFile.header;t+=`Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\r
`;for(const o of this.lines)t+=`Dialogue: ${o.Layer},${o.Start},${o.End},${o.Style},${o.Name},${o.MarginL},${o.MarginR},${o.MarginV},${o.Effect},${o.Text}\r
`;const s=new Blob([t],{type:"text/plain;charset=utf-8"}),e=URL.createObjectURL(s),i=document.createElement("a");i.href=e,i.download=this.fileName.replace(".ass","_RTL.ass"),i.click(),URL.revokeObjectURL(e)}catch(t){this.logError(`Failed to export file: ${t.message}`)}},setupResizeObserver(){this.$nextTick(()=>{if(this.$refs.videoContainer){this.resizeObserver&&this.resizeObserver.disconnect();const t=this.$refs.videoContainer.getBoundingClientRect();this.dummyVideo.containerWidth=t.width,this.dummyVideo.containerHeight=t.height,this.resizeLibassCanvas(),this.resizeLibassPartsCanvas(),this.renderLibassWasm(),this.renderLibassWasmParts(),this.resizeObserver=new ResizeObserver(s=>{for(const e of s)this.dummyVideo.containerWidth=e.contentRect.width,this.dummyVideo.containerHeight=e.contentRect.height,this.resizeLibassCanvas(),this.resizeLibassPartsCanvas(),this.renderLibassWasm(),this.renderLibassWasmParts()}),this.resizeObserver.observe(this.$refs.videoContainer)}})},cleanupResizeObserver(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},resetFile(){this.disposeLibassWasm(),this.disposeLibassWasmParts(),this.libassPartsFailed=!1,this.showResetConfirmModal=!1,this.assFile=null,this.originalFileSnapshot=null,this.lines=[],this.editedLineIndices=[],this.fileName="",this.fileSize="0 Bytes",this.isProcessing=!1,this.currentIndex=0,this.rtlPreviewText="",this.rtlEditHistory=Object.create(null),this.errorLog=[],this.scriptInfo=[],this.styles=[],this.dummyVideo.containerWidth=0,this.dummyVideo.containerHeight=0,this.overrideStats={fn:new Set,fs:new Set,colors:new Set,other:new Set},this.$refs.fileInput&&(this.$refs.fileInput.value="")}}});Vt.mount("#app");"serviceWorker"in navigator&&window.addEventListener("load",()=>{const t=new URL("service-worker.js",new URL(".",window.location.href));navigator.serviceWorker.register(t.toString()).then(s=>{console.log("Service Worker registered: ",s)}).catch(s=>{console.log("Service Worker registration failed: ",s)})});
